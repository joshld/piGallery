<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Frame Control</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .status-bar {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .status-item {
            text-align: center;
        }

        .status-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        .status-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .control-card.wide {
            max-width: 500px;
        }

        @media (max-width: 768px) {
            .control-card.wide {
                max-width: 100%;
            }
        }

        .control-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden; /* Prevent content from overflowing */
            box-sizing: border-box;
            width: 100%;
            max-width: 100%;
        }

        .control-card h2 {
            font-size: 1.3em;
            margin-bottom: 20px;
            color: #667eea;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        button {
            flex: 1;
            min-width: 120px;
            padding: 15px 25px;
            font-size: 1.1em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }

        button:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-full {
            width: 100%;
        }

        .upload-area {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .upload-area:hover {
            background: #f8f9ff;
            border-color: #764ba2;
        }

        .upload-area.dragover {
            background: #f0f0ff;
            border-color: #764ba2;
            transform: scale(1.02);
        }

        input[type="file"] {
            display: none;
        }

        .settings-group {
            margin-bottom: 20px;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            overflow: hidden; /* Prevent overflow */
        }

        .setting-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            overflow: visible; /* Allow content to be visible */
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-item-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            max-width: 100%;
            gap: 10px;
            box-sizing: border-box;
            overflow: hidden; /* Prevent overflow */
        }

        .setting-item-row > span {
            font-weight: 500;
            color: #333;
            flex: 1 1 auto;
            min-width: 0;
            flex-shrink: 0;
            overflow: visible;
            white-space: nowrap;
        }

        .setting-item-complex {
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 100%;
        }

        .setting-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            flex: 1 1 0;
            min-width: 0;
            max-width: 100%;
            width: 100%;
            box-sizing: border-box;
            overflow: visible; /* Allow content to be visible */
        }

        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: #ccc;
            border-radius: 15px;
            cursor: pointer;
            transition: background 0.3s;
            flex-shrink: 0; /* Don't shrink toggle switches */
        }

        .toggle-switch.active {
            background: #667eea;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: left 0.3s;
        }

        .toggle-switch.active::after {
            left: 33px;
        }

        input[type="number"],
        input[type="text"] {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            font-family: inherit;
            width: 140px;
            box-sizing: border-box;
            color: #333;
            background: #fff;
            text-align: center;
            margin: 0 auto;
        }

        input[type="text"]#location-city {
            width: 100%;
            margin: 0;
        }

        input[type="time"] {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            font-family: inherit;
            width: 140px;
            box-sizing: border-box;
            color: #333;
            background: #fff;
            text-align: center;
            margin: 0 auto;
        }

        input[type="number"]:focus,
        input[type="time"]:focus,
        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .browse-button {
            padding: 0;
            background: transparent;
            color: #667eea;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.2em;
            width: 28px;
            height: 28px;
            min-width: 28px;
            max-width: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 0 0 28px;
            transition: opacity 0.3s;
            box-sizing: border-box;
            line-height: 1;
            margin-top: 3px;
        }

        .browse-button:hover {
            opacity: 0.7;
        }

        .browse-button:active {
            transform: scale(0.95);
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 15px;
            width: 80%;
            max-width: 600px;
            max-height: 70vh;
            overflow: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .directory-list {
            list-style: none;
            padding: 0;
        }

        .directory-item {
            padding: 10px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .directory-item:hover {
            background: #e9ecef;
        }

        .directory-item::before {
            content: 'üìÅ';
            font-size: 1.2em;
        }

        .current-image {
            font-size: 1em;
            color: #666;
            word-break: break-all;
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .image-preview-container {
            margin-top: 20px;
            text-align: center;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
        }

        #image-preview {
            max-width: 100%;
            max-height: 400px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            object-fit: contain;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        #image-preview:hover {
            transform: scale(1.02);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .image-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            overflow: auto;
        }

        .image-modal-content {
            position: relative;
            margin: auto;
            padding: 20px;
            width: 90%;
            max-width: 90%;
            height: 90%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-modal img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 10px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
        }

        .image-modal-close {
            position: absolute;
            top: 20px;
            right: 40px;
            color: #fff;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }

        .image-modal-close:hover {
            color: #667eea;
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 1.8em;
            }

            .status-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .controls {
                grid-template-columns: 1fr;
            }

            .control-card {
                width: 100%;
                max-width: 100%;
            }

            .setting-item-row {
                flex-wrap: wrap;
            }

            .setting-item-row > span {
                flex: 0 0 100%;
                margin-bottom: 5px;
            }

            .setting-controls {
                width: 100%;
            }

            button {
                min-width: 100px;
                padding: 12px 20px;
                font-size: 1em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üñºÔ∏è piGallery Web Control</h1>
            <p>Control the piGallery from anywhere on the network</p>
        </header>

        <div class="alert" id="alert"></div>

        <div class="status-bar">
            <h2 style="margin-bottom: 15px; color: #667eea;">üìä Current Status</h2>
            <div class="status-grid">
                <div class="status-item">
                    <div class="status-label">‚è∞ Time</div>
                    <div class="status-value" id="status-time">--:--</div>
                </div>
                <div class="status-item">
                    <div class="status-label">üìÖ Date</div>
                    <div class="status-value" id="status-date">---</div>
                </div>
                <div class="status-item">
                    <div class="status-label">üå°Ô∏è Temperature</div>
                    <div class="status-value" id="status-temp">--¬∞C</div>
                </div>
                <div class="status-item">
                    <div class="status-label">‚òÅÔ∏è Weather</div>
                    <div class="status-value" id="status-weather">---</div>
                </div>
                <div class="status-item">
                    <div class="status-label">üì∏ Image</div>
                    <div class="status-value" id="status-index">- / -</div>
                </div>
                <div class="status-item">
                    <div class="status-label">‚ñ∂Ô∏è State</div>
                    <div class="status-value" id="status-paused">Playing</div>
                </div>
            </div>
            <div class="current-image-info" id="current-image">No image loaded</div>
            <div class="image-preview-container">
                <img id="image-preview" src="" alt="Current image preview" 
                     style="max-width: 100%; max-height: 400px; border-radius: 10px; 
                            box-shadow: 0 4px 15px rgba(0,0,0,0.2); display: none;"
                     onclick="showFullImage()" title="Click to view full-size image">
            </div>

            <div id="imageModal" class="image-modal" onclick="closeFullImage(event)">
                <span class="image-modal-close">&times;</span>
                <div class="image-modal-content">
                    <img id="full-image" src="" alt="Full-size image">
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="control-card">
                <h2>üéÆ Playback Controls</h2>
                <div class="button-group">
                    <button class="btn-primary" onclick="previousImage()">‚¨ÖÔ∏è Previous</button>
                    <button class="btn-primary" onclick="nextImage()">Next ‚û°Ô∏è</button>
                </div>
                <button class="btn-warning btn-full" onclick="togglePause()" id="pauseBtn">‚è∏Ô∏è Pause</button>
            </div>

            <div class="control-card">
                <h2>üí° Display Control</h2>
                <div class="button-group">
                    <button class="btn-success" onclick="setDisplay('on')">Turn On</button>
                    <button class="btn-danger" onclick="setDisplay('off')">Turn Off</button>
                </div>
                <button class="btn-primary btn-full" onclick="setDisplay('auto')">üîÑ Auto Mode</button>
            </div>

            <div class="control-card">
                <h2>üì§ Upload Photos</h2>
                <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                    <p style="font-size: 1.2em; margin-bottom: 10px;">üìÅ Click or Drop Files Here</p>
                    <p style="color: #666;">JPG, JPEG, PNG supported</p>
                    <input type="file" id="fileInput" accept="image/jpeg,image/jpg,image/png" multiple onchange="uploadFiles(this.files)">
                </div>
                <div id="uploadStatus"></div>
                
                <div style="margin-top: 25px; padding-top: 25px; border-top: 1px solid #eee;">
                    <h3 style="font-size: 1.3em; color: #667eea; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #667eea;">üìÅ Directories</h3>
                    <div class="settings-group">
                        <div class="setting-item">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <label style="font-weight: 500; color: #333; flex: 1;">Images Directory</label>
                                <button onclick="browseDirectory('images-directory')" class="browse-button" 
                                        title="Browse for directory">
                                    üìÅ
                                </button>
                            </div>
                            <input type="text" id="images-directory" placeholder="/path/to/images" 
                                   onchange="updateSetting('images_directory', this.value)"
                                   title="Click to edit or use browse button"
                                   style="width: 100%; padding: 8px 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em; color: #333; background: #fff; box-sizing: border-box; text-align: center;">
                        </div>
                        <div class="setting-item">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <label style="font-weight: 500; color: #333; flex: 1;">Upload Directory</label>
                                <button onclick="browseDirectory('upload-directory')" class="browse-button"
                                        title="Browse for directory">
                                    üìÅ
                                </button>
                            </div>
                            <input type="text" id="upload-directory" placeholder="Leave empty for default" 
                                   onchange="updateSetting('upload_directory', this.value)"
                                   title="Click to edit or use browse button"
                                   style="width: 100%; padding: 8px 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em; color: #333; background: #fff; box-sizing: border-box; text-align: center;">
                            <small style="display: block; color: #666; margin-top: 8px;">
                                (default: [ImagesDirectory]/uploaded/)
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="control-card">
                <h2>üëÅÔ∏è Display Options</h2>
                <div class="settings-group">
                    <div class="setting-item">
                        <div class="setting-item-row">
                            <span>Show Time</span>
                            <div class="toggle-switch" id="toggle-time" onclick="toggleSetting('show_time', this)"></div>
                        </div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-item-row">
                            <span>Show Date</span>
                            <div class="toggle-switch" id="toggle-date" onclick="toggleSetting('show_date', this)"></div>
                        </div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-item-row">
                            <span>Show Temperature</span>
                            <div class="toggle-switch" id="toggle-temp" onclick="toggleSetting('show_temperature', this)"></div>
                        </div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-item-row">
                            <span>Show Weather</span>
                            <div class="toggle-switch" id="toggle-weather" onclick="toggleSetting('show_weather_code', this)"></div>
                        </div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-item-row">
                            <span>Show Filename</span>
                            <div class="toggle-switch" id="toggle-filename" onclick="toggleSetting('show_filename', this)"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="control-card wide">
                <h2>‚öôÔ∏è Advanced Settings</h2>
                <div class="settings-group">
                    <div class="setting-item">
                        <label style="display: block; font-weight: 500; color: #333; margin-bottom: 8px;">Delay (seconds)</label>
                        <input type="number" id="delay-seconds" min="1" max="3600" value="30" 
                               onchange="updateSetting('delay_seconds', this.value)">
                    </div>
                    <div class="setting-item">
                        <label style="display: block; font-weight: 500; color: #333; margin-bottom: 8px;">Display On Time</label>
                        <input type="time" id="display-on-time" 
                               onchange="updateSetting('display_on_time', this.value)">
                    </div>
                    <div class="setting-item">
                        <label style="display: block; font-weight: 500; color: #333; margin-bottom: 8px;">Display Off Time</label>
                        <input type="time" id="display-off-time" 
                               onchange="updateSetting('display_off_time', this.value)">
                    </div>
                    <div class="setting-item">
                        <label style="display: block; font-weight: 500; color: #333; margin-bottom: 8px;">Location (City)</label>
                        <input type="text" id="location-city" placeholder="Sydney, Australia" 
                               onchange="updateSetting('location_city_suburb', this.value)"
                               style="width: 100%;">
                    </div>
                    <div class="setting-item">
                        <label style="display: block; font-weight: 500; color: #333; margin-bottom: 8px;">Weather Update (seconds)</label>
                        <input type="number" id="weather-update" min="60" max="3600" value="900" 
                               onchange="updateSetting('weather_update_seconds', this.value)">
                    </div>
                    <div class="setting-item">
                        <label style="display: block; font-weight: 500; color: #333; margin-bottom: 8px;">UI Text Alpha (0-255)</label>
                        <input type="number" id="ui-text-alpha" min="0" max="255" value="192" 
                               onchange="updateSetting('ui_text_alpha', this.value)">
                    </div>
                    <div class="setting-item">
                        <label style="display: block; font-weight: 500; color: #333; margin-bottom: 8px;">Aspect Ratio (Landscape)</label>
                        <input type="number" id="aspect-landscape" step="0.1" min="0.5" max="3.0" value="1.5" 
                               onchange="updateSetting('aspect_ratio_landscape', this.value)">
                    </div>
                    <div class="setting-item">
                        <label style="display: block; font-weight: 500; color: #333; margin-bottom: 8px;">Aspect Ratio (Portrait)</label>
                        <input type="number" id="aspect-portrait" step="0.1" min="0.1" max="1.0" value="0.667" 
                               onchange="updateSetting('aspect_ratio_portrait', this.value)">
                    </div>
                </div>
                <button class="btn-success btn-full" onclick="saveSettings()">üíæ Save Settings</button>
            </div>

            <div id="directoryModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Select Directory</h2>
                        <span class="close" onclick="closeDirectoryBrowser()">&times;</span>
                    </div>
                    <div id="directoryBrowser">
                        <p>Loading directories...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let settings = {};
        let isPaused = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus();
            loadSettings();
            setInterval(updateStatus, 3000); // Update every 3 seconds

            // Drag and drop
            const uploadArea = document.getElementById('uploadArea');
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                uploadFiles(e.dataTransfer.files);
            });
        });

        let lastImageName = '';
        let currentBrowsingField = null;
        let currentBrowsePath = '';

        async function browseDirectory(fieldId) {
            currentBrowsingField = fieldId;
            currentBrowsePath = '';
            document.getElementById('directoryModal').style.display = 'block';
            await loadDirectories('');
        }

        function closeDirectoryBrowser() {
            document.getElementById('directoryModal').style.display = 'none';
            currentBrowsingField = null;
            currentBrowsePath = '';
        }

        async function loadDirectories(path) {
            try {
                const url = path ? `/api/directories?path=${encodeURIComponent(path)}` : '/api/directories';
                const response = await fetch(url);
                const data = await response.json();
                
                if (response.ok) {
                    currentBrowsePath = data.current_path || '';
                    const browserDiv = document.getElementById('directoryBrowser');
                    
                    let html = '';
                    
                    // Show current path
                    if (currentBrowsePath) {
                        html += `<div style="margin-bottom: 15px; padding: 10px; background: #f0f0f0; border-radius: 5px;">`;
                        html += `<strong>Current Path:</strong> ${currentBrowsePath}`;
                        html += `</div>`;
                    }
                    
                    // Parent directory button
                    if (data.parent_path !== null && data.parent_path !== undefined) {
                        const escapedParent = data.parent_path.replace(/'/g, "\\'").replace(/\\/g, '\\\\');
                        html += `<div class="directory-item" onclick="loadDirectories('${escapedParent}')">`;
                        html += `<strong>.. (Parent Directory)</strong>`;
                        html += `</div>`;
                    }
                    
                    // List directories
                    if (data.directories && data.directories.length > 0) {
                        data.directories.forEach(dir => {
                            // Check if this is a Windows drive letter (e.g., "C:\")
                            const isDriveLetter = /^[A-Z]:\\?$/.test(dir);
                            
                            if (isDriveLetter) {
                                // It's a drive letter - navigate into it
                                const escapedPath = dir.replace(/'/g, "\\'").replace(/\\/g, '\\\\');
                                html += `<div class="directory-item" onclick="loadDirectories('${escapedPath}')">${dir}</div>`;
                            } else if (currentBrowsePath) {
                                // Regular directory - construct full path
                                // Determine separator based on current path format
                                let separator = '/';
                                if (currentBrowsePath.includes('\\') && !currentBrowsePath.includes('/')) {
                                    // Windows path
                                    separator = '\\';
                                }
                                
                                // Only add separator if path doesn't already end with one
                                const needsSeparator = !currentBrowsePath.endsWith('/') && !currentBrowsePath.endsWith('\\');
                                const fullPath = `${currentBrowsePath}${separator}${dir}`;
                                const escapedPath = fullPath.replace(/'/g, "\\'").replace(/\\/g, '\\\\');
                                html += `<div class="directory-item" onclick="loadDirectories('${escapedPath}')">${dir}</div>`;
                            } else {
                                // No current path - treat as full path (shouldn't happen, but handle it)
                                const escapedPath = dir.replace(/'/g, "\\'").replace(/\\/g, '\\\\');
                                html += `<div class="directory-item" onclick="loadDirectories('${escapedPath}')">${dir}</div>`;
                            }
                        });
                    } else {
                        html += `<p>No subdirectories found.</p>`;
                    }
                    
                    // Select current directory button
                    if (currentBrowsePath) {
                        const escapedPath = currentBrowsePath.replace(/'/g, "\\'").replace(/\\/g, '\\\\');
                        html += `<div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #667eea;">`;
                        html += `<button class="btn-success btn-full" onclick="selectDirectory('${escapedPath}')">`;
                        html += `‚úì Select This Directory`;
                        html += `</button>`;
                        html += `</div>`;
                    }
                    
                    browserDiv.innerHTML = html;
                } else {
                    document.getElementById('directoryBrowser').innerHTML = 
                        `<p style="color: red;">Error: ${data.error}</p>`;
                }
            } catch (error) {
                document.getElementById('directoryBrowser').innerHTML = 
                    `<p style="color: red;">Error loading directories: ${error.message}</p>`;
            }
        }

        function selectDirectory(path) {
            if (currentBrowsingField) {
                document.getElementById(currentBrowsingField).value = path;
                updateSetting(currentBrowsingField.replace('-', '_'), path);
                closeDirectoryBrowser();
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('directoryModal');
            if (event.target == modal) {
                closeDirectoryBrowser();
            }
        }

        async function updateStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                document.getElementById('status-time').textContent = data.time || '--:--';
                document.getElementById('status-date').textContent = data.date || '---';
                document.getElementById('status-temp').textContent = data.temperature || '--¬∞C';
                document.getElementById('status-weather').textContent = data.weather || '---';
                document.getElementById('status-index').textContent = `${data.current_index} / ${data.total_images}`;
                document.getElementById('status-paused').textContent = data.paused ? 'Paused' : 'Playing';
                document.getElementById('current-image').textContent = data.current_image || 'No image loaded';
                
                // Update image preview only when image changes
                const previewImg = document.getElementById('image-preview');
                if (data.current_image && data.current_image !== lastImageName) {
                    previewImg.src = `/api/image/preview?t=${Date.now()}`;
                    previewImg.style.display = 'block';
                    lastImageName = data.current_image;
                } else if (!data.current_image) {
                    previewImg.style.display = 'none';
                    lastImageName = '';
                }
                
                isPaused = data.paused;
                document.getElementById('pauseBtn').textContent = isPaused ? '‚ñ∂Ô∏è Resume' : '‚è∏Ô∏è Pause';
            } catch (error) {
                console.error('Failed to update status:', error);
            }
        }

        async function loadSettings() {
            try {
                const response = await fetch('/api/settings');
                settings = await response.json();
                
                // Update toggle switches
                updateToggle('toggle-time', settings.show_time === 'true');
                updateToggle('toggle-date', settings.show_date === 'true');
                updateToggle('toggle-temp', settings.show_temperature === 'true');
                updateToggle('toggle-weather', settings.show_weather_code === 'true');
                updateToggle('toggle-filename', settings.show_filename === 'true');

                // Update input fields
                if (document.getElementById('delay-seconds')) {
                    document.getElementById('delay-seconds').value = settings.delay_seconds || 30;
                }
                if (document.getElementById('display-on-time')) {
                    document.getElementById('display-on-time').value = settings.display_on_time || '05:00';
                }
                if (document.getElementById('display-off-time')) {
                    document.getElementById('display-off-time').value = settings.display_off_time || '23:00';
                }
                if (document.getElementById('location-city')) {
                    document.getElementById('location-city').value = settings.location_city_suburb || '';
                }
                if (document.getElementById('ui-text-alpha')) {
                    document.getElementById('ui-text-alpha').value = settings.ui_text_alpha || 192;
                }
                if (document.getElementById('aspect-landscape')) {
                    document.getElementById('aspect-landscape').value = settings.aspect_ratio_landscape || 1.5;
                }
                if (document.getElementById('aspect-portrait')) {
                    document.getElementById('aspect-portrait').value = settings.aspect_ratio_portrait || 0.667;
                }
                if (document.getElementById('weather-update')) {
                    document.getElementById('weather-update').value = settings.weather_update_seconds || 900;
                }
                if (document.getElementById('images-directory')) {
                    document.getElementById('images-directory').value = settings.images_directory || '';
                }
                if (document.getElementById('upload-directory')) {
                    document.getElementById('upload-directory').value = settings.upload_directory || '';
                }
            } catch (error) {
                console.error('Failed to load settings:', error);
            }
        }

        function updateSetting(key, value) {
            settings[key] = value;
            // Optionally auto-save, or wait for "Save Settings" button
        }

        function updateToggle(id, active) {
            const element = document.getElementById(id);
            if (active) {
                element.classList.add('active');
            } else {
                element.classList.remove('active');
            }
        }

        function toggleSetting(key, element) {
            element.classList.toggle('active');
            const isActive = element.classList.contains('active');
            settings[key] = isActive ? 'true' : 'false';
        }

        async function saveSettings() {
            try {
                // Collect all settings from form
                const allSettings = {
                    ...settings,
                    delay_seconds: parseInt(document.getElementById('delay-seconds')?.value || settings.delay_seconds),
                    display_on_time: document.getElementById('display-on-time')?.value || settings.display_on_time,
                    display_off_time: document.getElementById('display-off-time')?.value || settings.display_off_time,
                    location_city_suburb: document.getElementById('location-city')?.value || settings.location_city_suburb,
                    weather_update_seconds: parseInt(document.getElementById('weather-update')?.value || settings.weather_update_seconds),
                    ui_text_alpha: parseInt(document.getElementById('ui-text-alpha')?.value || settings.ui_text_alpha),
                    aspect_ratio_landscape: parseFloat(document.getElementById('aspect-landscape')?.value || settings.aspect_ratio_landscape),
                    aspect_ratio_portrait: parseFloat(document.getElementById('aspect-portrait')?.value || settings.aspect_ratio_portrait),
                    images_directory: document.getElementById('images-directory')?.value || settings.images_directory,
                    upload_directory: document.getElementById('upload-directory')?.value || settings.upload_directory,
                    save_to_config: true
                };
                
                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(allSettings)
                });
                
                if (response.ok) {
                    showAlert('Settings saved successfully!', 'success');
                } else {
                    showAlert('Failed to save settings', 'error');
                }
            } catch (error) {
                showAlert('Error saving settings: ' + error.message, 'error');
            }
        }

        async function nextImage() {
            try {
                const response = await fetch('/api/next', { method: 'POST' });
                if (response.ok) {
                    updateStatus();
                    showAlert('Moved to next image', 'success');
                }
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            }
        }

        async function previousImage() {
            try {
                const response = await fetch('/api/prev', { method: 'POST' });
                if (response.ok) {
                    updateStatus();
                    showAlert('Moved to previous image', 'success');
                }
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            }
        }

        async function togglePause() {
            try {
                const response = await fetch('/api/pause', { method: 'POST' });
                if (response.ok) {
                    updateStatus();
                    const data = await response.json();
                    showAlert(data.paused ? 'Slideshow paused' : 'Slideshow resumed', 'success');
                }
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            }
        }

        async function setDisplay(action) {
            try {
                const response = await fetch('/api/display', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action })
                });
                
                if (response.ok) {
                    const messages = {
                        'on': 'Display turned on',
                        'off': 'Display turned off',
                        'auto': 'Display set to auto mode'
                    };
                    showAlert(messages[action], 'success');
                    updateStatus();
                }
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            }
        }

        async function uploadFiles(files) {
            const uploadStatus = document.getElementById('uploadStatus');
            uploadStatus.innerHTML = '';

            for (let file of files) {
                const formData = new FormData();
                formData.append('file', file);

                try {
                    uploadStatus.innerHTML += `<p>Uploading ${file.name}...</p>`;
                    const response = await fetch('/api/upload', {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        uploadStatus.innerHTML += `<p style="color: green;">‚úÖ ${file.name} uploaded successfully!</p>`;
                        showAlert(`Uploaded ${file.name}`, 'success');
                    } else {
                        const data = await response.json();
                        uploadStatus.innerHTML += `<p style="color: red;">‚ùå ${file.name}: ${data.error}</p>`;
                    }
                } catch (error) {
                    uploadStatus.innerHTML += `<p style="color: red;">‚ùå ${file.name}: ${error.message}</p>`;
                }
            }

            // Clear file input
            document.getElementById('fileInput').value = '';
            
            // Refresh status after upload
            setTimeout(updateStatus, 1000);
        }

        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = `alert ${type}`;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 3000);
        }

        function showFullImage() {
            const modal = document.getElementById('imageModal');
            const fullImg = document.getElementById('full-image');
            const previewImg = document.getElementById('image-preview');
            
            if (previewImg.src) {
                // Use the full image endpoint
                fullImg.src = `/api/image/full?t=${Date.now()}`;
                modal.style.display = 'block';
            }
        }

        function closeFullImage(event) {
            const modal = document.getElementById('imageModal');
            // Close if clicking on the background or the close button
            if (event.target === modal || event.target.classList.contains('image-modal-close')) {
                modal.style.display = 'none';
            }
        }

        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('imageModal');
                if (modal.style.display === 'block') {
                    modal.style.display = 'none';
                }
            }
        });
    </script>
</body>
</html>
