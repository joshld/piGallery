<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Frame Control</title>
    <link rel="stylesheet" href="/static/themes.css">
    <style>
        /* CSS Variables - Default Theme (Current Colors) */
        :root {
            /* Background */
            --bg-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-card: #ffffff;
            --bg-input: #ffffff;
            --bg-hover: #f8f9ff;
            --bg-dragover: #f0f0ff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e9ecef;
            --bg-modal: rgba(0,0,0,0.5);
            --bg-modal-content: #ffffff;
            --bg-image-modal: rgba(0,0,0,0.9);
            --bg-log-viewer: #1e1e1e;
            --bg-directory-item: #f8f9fa;
            --bg-directory-item-hover: #e9ecef;
            --bg-toggle: #ccc;
            --bg-toggle-active: #667eea;
            
            /* Text */
            --text-primary: #333333;
            --text-secondary: #666666;
            --text-header: #ffffff;
            --text-log: #d4d4d4;
            --text-caption: #666666;
            
            /* Accent Colors */
            --accent-primary: #667eea;
            --accent-secondary: #764ba2;
            --accent-border: #667eea;
            --accent-border-hover: #764ba2;
            
            /* Status Colors */
            --status-value: #667eea;
            
            /* Button Gradients */
            --btn-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --btn-success: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            --btn-danger: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            --btn-warning: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --btn-secondary: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            --btn-info: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            --btn-save: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            --btn-save-saved: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --btn-text: #ffffff;
            
            /* Tab Colors */
            --tab-bg: rgba(255, 255, 255, 0.2);
            --tab-bg-hover: rgba(255, 255, 255, 0.3);
            --tab-bg-active: #ffffff;
            --tab-text: #ffffff;
            --tab-text-active: #667eea;
            --tab-border: rgba(255, 255, 255, 0.3);
            
            /* Alert Colors */
            --alert-success-bg: #d4edda;
            --alert-success-text: #155724;
            --alert-success-border: #28a745;
            --alert-error-bg: #f8d7da;
            --alert-error-text: #721c24;
            --alert-error-border: #dc3545;
            --alert-warning-bg: #fff3cd;
            --alert-warning-text: #856404;
            --alert-warning-border: #ffc107;
            
            /* Input Colors */
            --input-border: #dddddd;
            --input-border-focus: #667eea;
            --input-text: #333333;
            
            /* Modal Colors */
            --modal-close: #aaaaaa;
            --modal-close-hover: #000000;
            --modal-header-border: #667eea;
            --image-modal-close: #ffffff;
            --image-modal-close-hover: #667eea;
            
            /* Shadows */
            --shadow-card: 0 10px 30px rgba(0,0,0,0.2);
            --shadow-button: 0 4px 15px rgba(0,0,0,0.1);
            --shadow-button-hover: 0 6px 20px rgba(0,0,0,0.2);
            --shadow-save-button: 0 8px 25px rgba(17, 153, 142, 0.4);
            --shadow-save-button-hover: 0 12px 35px rgba(17, 153, 142, 0.5);
            --shadow-modal: 0 10px 30px rgba(0,0,0,0.3);
            --shadow-image: 0 4px 15px rgba(0,0,0,0.2);
            --shadow-image-hover: 0 6px 20px rgba(0,0,0,0.3);
            --shadow-image-modal: 0 8px 32px rgba(0,0,0,0.5);
            --shadow-alert: 0 8px 25px rgba(0,0,0,0.3);
            
            /* Borders */
            --border-divider: #eeeeee;
            --border-setting: 1px solid #eee;
        }
        
        /* All theme definitions are loaded from themes.css */
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: var(--text-header);
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .tab-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--tab-border);
        }

        .tab-button {
            background: var(--tab-bg);
            border: none;
            color: var(--tab-text);
            padding: 12px 24px;
            font-size: 1.1em;
            font-weight: 500;
            cursor: pointer;
            border-radius: 10px 10px 0 0;
            transition: all 0.3s;
            margin-bottom: -2px;
        }

        .tab-button:hover {
            background: var(--tab-bg-hover);
        }

        .tab-button.active {
            background: var(--tab-bg-active);
            color: var(--tab-text-active);
            border-bottom: 2px solid var(--tab-bg-active);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .status-bar {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-card);
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .status-item {
            text-align: center;
        }

        .status-label {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .status-value {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--status-value);
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .control-card.wide {
            max-width: 500px;
        }

        @media (max-width: 768px) {
            .control-card.wide {
                max-width: 100%;
            }
        }

        .control-card {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 25px;
            box-shadow: var(--shadow-card);
            overflow: hidden; /* Prevent content from overflowing */
            box-sizing: border-box;
            width: 100%;
            max-width: 100%;
        }

        .control-card h2 {
            font-size: 1.3em;
            margin-bottom: 20px;
            color: var(--accent-primary);
            border-bottom: 2px solid var(--accent-primary);
            padding-bottom: 10px;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        button {
            flex: 1;
            min-width: 120px;
            padding: 15px 25px;
            font-size: 1.1em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            box-shadow: var(--shadow-button);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-button-hover);
        }

        button:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: var(--btn-primary);
            color: var(--btn-text);
        }

        .btn-success {
            background: var(--btn-success);
            color: var(--btn-text);
        }

        .btn-danger {
            background: var(--btn-danger);
            color: var(--btn-text);
        }

        .btn-warning {
            background: var(--btn-warning);
            color: var(--btn-text);
        }

        .btn-secondary {
            background: var(--btn-secondary);
            color: var(--btn-text);
        }

        .btn-info {
            background: var(--btn-info);
            color: var(--btn-text);
        }

        .btn-full {
            width: 100%;
        }

        .upload-area {
            border: 2px dashed var(--accent-border);
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .upload-area:hover {
            background: var(--bg-hover);
            border-color: var(--accent-border-hover);
        }

        .upload-area.dragover {
            background: var(--bg-dragover);
            border-color: var(--accent-border-hover);
            transform: scale(1.02);
        }

        input[type="file"] {
            display: none;
        }

        .settings-group {
            margin-bottom: 20px;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            overflow: hidden; /* Prevent overflow */
        }

        .setting-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 12px 0;
            border-bottom: var(--border-setting);
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            overflow: visible; /* Allow content to be visible */
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-item-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            max-width: 100%;
            gap: 10px;
            box-sizing: border-box;
            overflow: visible; /* Allow content to be visible */
        }

        .setting-item-row > span {
            font-weight: 500;
            color: var(--text-primary);
            flex: 1 1 auto;
            min-width: 0;
            flex-shrink: 1;
            overflow: visible;
            white-space: normal;
            word-wrap: break-word;
        }

        .setting-item-complex {
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 100%;
        }

        .setting-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            flex: 1 1 0;
            min-width: 0;
            max-width: 100%;
            width: 100%;
            box-sizing: border-box;
            overflow: visible; /* Allow content to be visible */
        }

        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: var(--bg-toggle);
            border-radius: 15px;
            cursor: pointer;
            transition: background 0.3s;
            flex-shrink: 0; /* Don't shrink toggle switches */
            margin-left: auto; /* Always push to the right */
        }

        .toggle-switch.active {
            background: var(--bg-toggle-active);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: left 0.3s;
        }

        .toggle-switch.active::after {
            left: 33px;
        }

        input[type="text"] {
            padding: 8px 12px;
            border: 2px solid var(--input-border);
            border-radius: 8px;
            font-size: 1em;
            font-family: inherit;
            width: 140px;
            box-sizing: border-box;
            color: var(--input-text);
            background: var(--bg-input);
            text-align: left;
            margin: 0;
        }

        input[type="number"] {
            padding: 8px 12px;
            border: 2px solid var(--input-border);
            border-radius: 8px;
            font-size: 1em;
            font-family: inherit;
            width: 140px;
            box-sizing: border-box;
            color: var(--input-text);
            background: var(--bg-input);
            text-align: center;
            margin: 0;
        }

        input[type="text"]#location-city {
            width: 100%;
            margin: 0;
            text-align: left;
        }

        input[type="time"] {
            padding: 8px 12px;
            border: 2px solid var(--input-border);
            border-radius: 8px;
            font-size: 1em;
            font-family: inherit;
            width: 140px;
            box-sizing: border-box;
            color: var(--input-text);
            background: var(--bg-input);
            text-align: left;
            margin: 0;
        }

        input[type="number"]:focus,
        input[type="time"]:focus,
        input[type="text"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--input-border-focus);
        }
        
        textarea {
            color: var(--input-text);
            background: var(--bg-input);
            border: 2px solid var(--input-border);
        }
        
        select {
            color: var(--input-text);
            background: var(--bg-input);
            border: 2px solid var(--input-border);
        }

        .browse-button {
            padding: 0;
            background: transparent;
            color: var(--accent-primary);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.2em;
            width: 28px;
            height: 28px;
            min-width: 28px;
            max-width: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 0 0 28px;
            transition: opacity 0.3s;
            box-sizing: border-box;
            line-height: 1;
            margin-top: 3px;
        }

        .browse-button:hover {
            opacity: 0.7;
        }

        .browse-button:active {
            transform: scale(0.95);
        }

        .alert {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            padding: 15px 25px;
            border-radius: 10px;
            display: none;
            min-width: 300px;
            max-width: 90%;
            text-align: center;
            box-shadow: var(--shadow-alert);
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .alert.success {
            background: var(--alert-success-bg);
            color: var(--alert-success-text);
            border: 2px solid var(--alert-success-border);
        }

        .alert.error {
            background: var(--alert-error-bg);
            color: var(--alert-error-text);
            border: 2px solid var(--alert-error-border);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-modal);
        }

        .modal-content {
            background-color: var(--bg-modal-content);
            margin: 10% auto;
            padding: 20px;
            border-radius: 15px;
            width: 80%;
            max-width: 600px;
            max-height: 70vh;
            overflow: auto;
            box-shadow: var(--shadow-modal);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--modal-header-border);
            padding-bottom: 10px;
        }

        .close {
            color: var(--modal-close);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: var(--modal-close-hover);
        }

        .directory-list {
            list-style: none;
            padding: 0;
        }

        .directory-item {
            padding: 10px;
            margin: 5px 0;
            background: var(--bg-directory-item);
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .directory-item:hover {
            background: var(--bg-directory-item-hover);
        }

        .directory-item::before {
            content: 'üìÅ';
            font-size: 1.2em;
        }

        .current-image {
            font-size: 1em;
            color: var(--text-secondary);
            word-break: break-all;
            margin-top: 10px;
            padding: 10px;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        .image-preview-container {
            margin-top: 20px;
            text-align: center;
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 10px;
        }

        .playback-controls-below-preview {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .playback-controls-below-preview button {
            flex: 0 0 auto;
            min-width: 120px;
        }

        #image-preview {
            max-width: 100%;
            max-height: 400px;
            border-radius: 10px;
            box-shadow: var(--shadow-image);
            object-fit: contain;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        #image-preview:hover {
            transform: scale(1.02);
            box-shadow: var(--shadow-image-hover);
        }

        .image-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-image-modal);
            overflow: auto;
        }

        .image-modal-content {
            position: relative;
            margin: auto;
            padding: 20px;
            width: 90%;
            max-width: 90%;
            height: 90%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-modal img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 10px;
            box-shadow: var(--shadow-image-modal);
        }

        .image-modal-close {
            position: absolute;
            top: 20px;
            right: 40px;
            color: var(--image-modal-close);
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }

        .image-modal-close:hover {
            color: var(--image-modal-close-hover);
        }

        .sticky-save-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 999;
            padding: 18px 30px;
            font-size: 1.2em;
            font-weight: 600;
            background: var(--btn-save);
            color: var(--btn-text);
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: var(--shadow-save-button);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(20px);
        }

        .sticky-save-button.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .sticky-save-button:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-save-button-hover);
        }

        .sticky-save-button:active {
            transform: translateY(-1px);
        }

        .sticky-save-button.saved {
            background: var(--btn-save-saved);
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            gap: 15px;
            flex-wrap: wrap;
        }

        .log-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .caption-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .caption-controls button {
            flex: 0 0 auto;
            min-width: 150px;
        }

        #save-caption-btn,
        #load-caption-btn {
            width: 180px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            white-space: nowrap;
        }

        .caption-status {
            color: var(--text-caption);
            font-size: 0.9em;
            flex: 1 1 auto;
            word-wrap: break-word;
            overflow-wrap: break-word;
            min-height: 20px;
        }
        
        /* Text color utility classes */
        .text-primary {
            color: var(--text-primary);
        }
        
        .text-secondary {
            color: var(--text-secondary);
        }
        
        .text-accent {
            color: var(--accent-primary);
        }
        
        .text-label {
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .text-small {
            color: var(--text-secondary);
            font-size: 0.85em;
        }
        
        .bg-secondary {
            background: var(--bg-secondary);
        }
        
        .bg-tertiary {
            background: var(--bg-tertiary);
        }
        
        .border-divider {
            border: 1px solid var(--border-divider);
        }
        
        .border-accent {
            border-color: var(--accent-border);
        }

        .log-viewer {
            background: var(--bg-log-viewer);
            color: var(--text-log);
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 500px;
            overflow-y: auto;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            word-break: break-all;
            line-height: 1.5;
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 1.8em;
            }

            .status-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .controls {
                grid-template-columns: 1fr;
            }

            .control-card {
                width: 100%;
                max-width: 100%;
            }

            .setting-item-row {
                flex-wrap: nowrap;
            }

            .setting-item-row > span {
                flex: 1 1 auto;
                min-width: 0;
                font-size: 0.9em;
            }

            .toggle-switch {
                flex-shrink: 0;
            }

            .setting-controls {
                width: 100%;
            }

            button {
                min-width: 100px;
                padding: 12px 20px;
                font-size: 1em;
            }

            .sticky-save-button {
                bottom: 20px;
                right: 20px;
                padding: 15px 25px;
                font-size: 1.1em;
            }

            .log-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .log-controls {
                width: 100%;
                justify-content: stretch;
            }

            .log-controls select {
                flex: 1;
                min-width: 0;
                font-size: 0.9em;
                padding: 6px 8px;
            }

            .log-controls button {
                flex-shrink: 0;
                padding: 6px 12px;
                font-size: 0.9em;
            }

            .alert {
                top: 10px;
                min-width: auto;
                max-width: 95%;
                padding: 12px 20px;
                font-size: 0.9em;
            }

            .caption-controls {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }

            .caption-controls button {
                width: 100% !important;
                min-width: 0;
            }

            #save-caption-btn,
            #load-caption-btn {
                width: 100% !important;
                height: 45px;
            }

            .caption-status {
                flex: 1 1 100%;
                width: 100%;
                text-align: center;
                font-size: 0.85em;
                min-height: 20px;
                padding-top: 4px;
                padding-left: 0;
            }

            .log-viewer {
                font-size: 0.65em;
                padding: 8px;
                max-height: 350px;
                line-height: 1.3;
                overflow-x: hidden;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üñºÔ∏è piGallery Web Control</h1>
            <p>Control the piGallery from anywhere on the network</p>
        </header>

        <div class="alert" id="alert"></div>

        <div class="tab-container">
            <button class="tab-button active" onclick="switchTab('status')">üìä Status</button>
            <button class="tab-button" onclick="switchTab('system')">üíª System</button>
        </div>

        <div id="tab-status" class="tab-content active">
        <div class="status-bar">
            <h2 style="margin-bottom: 15px;" class="text-accent">üìä Current Device Status</h2>
            <div class="status-grid">
                <div class="status-item">
                    <div class="status-label">‚è∞ Time</div>
                    <div class="status-value" id="status-time">--:--</div>
                </div>
                <div class="status-item">
                    <div class="status-label">üìÖ Date</div>
                    <div class="status-value" id="status-date">---</div>
                </div>
                <div class="status-item">
                    <div class="status-label">üå°Ô∏è Temperature</div>
                    <div class="status-value" id="status-temp">--¬∞C</div>
                </div>
                <div class="status-item">
                    <div class="status-label">‚òÅÔ∏è Weather</div>
                    <div class="status-value" id="status-weather">---</div>
                </div>
                <div class="status-item">
                    <div class="status-label">üì∏ Image</div>
                    <div class="status-value" id="status-index">- / -</div>
                </div>
                <div class="status-item">
                    <div class="status-label">‚ñ∂Ô∏è State</div>
                    <div class="status-value" id="status-paused">Playing</div>
                </div>
                <div class="status-item">
                    <div class="status-label">‚è±Ô∏è Next Image In</div>
                    <div class="status-value" id="status-countdown">--s</div>
            </div>
        </div>
            <div class="image-preview-container">
                <h3 style="margin-bottom: 15px; font-size: 1.1em;" class="text-accent">üì∏ Current Image</h3>
                <div class="current-image-info text-secondary" id="current-image" style="margin-bottom: 15px; font-size: 0.95em;">No image loaded</div>
                <div style="display: flex; justify-content: center; align-items: center; width: 100%;">
                    <img id="image-preview" src="" alt="Current image preview" 
                         style="max-width: 100%; max-height: 400px; border-radius: 10px; 
                                box-shadow: 0 4px 15px rgba(0,0,0,0.2); display: none;"
                         onclick="showFullImage()" title="Click to view full-size image">
                </div>
                <div class="playback-controls-below-preview">
                    <button class="btn-primary" onclick="previousImage()">‚¨ÖÔ∏è Previous</button>
                    <button class="btn-warning" onclick="togglePause()" id="pauseBtn">‚è∏Ô∏è Pause</button>
                    <button class="btn-primary" onclick="nextImage()">Next ‚û°Ô∏è</button>
                </div>
            </div>

            <div class="caption-editor-container bg-secondary" style="margin-top: 30px; padding: 20px; border-radius: 10px; border: 1px solid var(--border-divider);">
                <h3 style="margin-bottom: 15px; font-size: 1.1em;" class="text-accent">‚úèÔ∏è Image Caption</h3>
                <div style="margin-bottom: 10px;">
                    <textarea id="caption-text" placeholder="Enter caption for this image (saved to image metadata)..." 
                              style="width: 100%; min-height: 100px; padding: 12px; border: 2px solid var(--input-border); border-radius: 8px; font-size: 0.95em; font-family: inherit; resize: vertical; box-sizing: border-box; color: var(--input-text); background: var(--bg-input);"></textarea>
                </div>
                <div class="caption-controls">
                    <button class="btn-success" onclick="saveCaption()" id="save-caption-btn">üíæ Save Caption</button>
                    <button class="btn-secondary" onclick="loadCaption()" id="load-caption-btn">üîÑ Reload</button>
                    <span id="caption-status" class="caption-status"></span>
                </div>
            </div>

            <div id="imageModal" class="image-modal" onclick="closeFullImage(event)">
                <span class="image-modal-close">&times;</span>
                <div class="image-modal-content">
                    <img id="full-image" src="" alt="Full-size image">
                </div>
            </div>
        </div>

        <div class="controls">

            <div class="control-card">
                <h2>üí° Display Control</h2>
                <div class="button-group">
                    <button class="btn-success" onclick="setDisplay('on')">Turn On</button>
                    <button class="btn-secondary" onclick="setDisplay('off')">Turn Off</button>
                </div>
                <button class="btn-primary btn-full" onclick="setDisplay('auto')">üîÑ Auto Mode</button>
                
                <div style="margin-top: 25px; padding-top: 25px; border-top: 1px solid var(--border-divider);"></div>
                <h2>‚ö° System Power</h2>
                <small class="text-small" style="display: block; margin-top: 10px; border-radius: 8px; padding: 10px;">
                    ‚ö†Ô∏è Requires sudo privileges. System will countdown before executing.
                </small>
                <div class="button-group" id="power-buttons-container">
                    <button class="btn-danger" onclick="confirmShutdown()">üî¥ Shutdown</button>
                    <button class="btn-info" onclick="confirmRestart()">üîÑ Restart</button>
                </div>
                <div id="power-action-status" style="display: none; margin-top: 10px; padding: 10px; background: var(--alert-warning-bg); border: 1px solid var(--alert-warning-border); border-radius: 8px; color: var(--alert-warning-text);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span id="power-action-message">‚è≥ Power action in progress...</span>
                        <button class="btn-secondary" style="padding: 6px 15px; font-size: 0.9em;" onclick="cancelPowerAction()">‚ùå Cancel</button>
                    </div>
                </div>
            </div>

            <div class="control-card">
                <h2>üì§ Upload Photos</h2>
                <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                    <p style="font-size: 1.2em; margin-bottom: 10px;">üìÅ Click or Drop Files Here</p>
                    <p class="text-secondary">JPG, JPEG, PNG supported</p>
                    <input type="file" id="fileInput" accept="image/jpeg,image/jpg,image/png" multiple onchange="handleFileSelect(this.files)">
                </div>
                
                <div id="uploadPreview" style="display: none; margin-top: 20px;">
                    <h3 style="font-size: 1.1em; margin-bottom: 15px;" class="text-accent">üìã Files Ready to Upload</h3>
                    <div id="fileList" class="bg-secondary" style="margin-bottom: 15px; max-height: 200px; overflow-y: auto; border: 1px solid var(--input-border); border-radius: 8px; padding: 8px; width: 100%; box-sizing: border-box;"></div>
                    
                    <div style="margin-top: 15px;">
                        <label class="text-label" style="display: block; margin-bottom: 8px;">‚úèÔ∏è Caption (optional - applies to all uploaded files)</label>
                        <textarea id="upload-caption" placeholder="Enter a caption to add to all uploaded photos..." 
                                  style="width: 100%; min-height: 60px; padding: 10px; border: 2px solid var(--input-border); border-radius: 8px; font-size: 0.95em; font-family: inherit; resize: vertical; box-sizing: border-box; color: var(--input-text); background: var(--bg-input);"></textarea>
                    </div>
                    
                    <div style="margin-top: 15px; display: flex; gap: 8px; justify-content: center;">
                        <button class="btn-success" onclick="uploadSelectedFiles()" id="uploadBtn" style="padding: 8px 16px; font-size: 0.9em;">üì§ Upload All</button>
                        <button class="btn-secondary" onclick="clearFileSelection()" style="padding: 8px 16px; font-size: 0.9em;">üóëÔ∏è Clear</button>
                    </div>
                </div>
                
                <div id="uploadStatus" style="margin-top: 15px;"></div>
                
                <div style="margin-top: 25px; padding-top: 25px; border-top: 1px solid var(--border-divider);">
                    <h3 style="font-size: 1.3em; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid var(--accent-primary);" class="text-accent">üìÅ Directories</h3>
                    <div class="settings-group">
                        <div class="setting-item">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <label class="text-label" style="flex: 1;">Images Directory</label>
                                <button onclick="browseDirectory('images-directory')" class="browse-button" 
                                        title="Browse for directory">
                                    üìÅ
                                </button>
                            </div>
                            <input type="text" id="images-directory" placeholder="/path/to/images" 
                                   onchange="updateSetting('images_directory', this.value)"
                                   title="Click to edit or use browse button"
                                   style="width: 100%; padding: 8px 12px; border: 2px solid var(--input-border); border-radius: 8px; font-size: 1em; color: var(--input-text); background: var(--bg-input); box-sizing: border-box; text-align: left;">
                        </div>
                        <div class="setting-item">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <label class="text-label" style="flex: 1;">Upload Directory</label>
                                <button onclick="browseDirectory('upload-directory')" class="browse-button"
                                        title="Browse for directory">
                                    üìÅ
                                </button>
                            </div>
                            <input type="text" id="upload-directory" placeholder="Leave empty for default" 
                                   onchange="updateSetting('upload_directory', this.value)"
                                   title="Click to edit or use browse button"
                                   style="width: 100%; padding: 8px 12px; border: 2px solid var(--input-border); border-radius: 8px; font-size: 1em; color: var(--input-text); background: var(--bg-input); box-sizing: border-box; text-align: left;">
                            <small class="text-small" style="display: block; margin-top: 8px;">
                                default: [ImagesDirectory]/uploaded/
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="control-card">
                <h2>üëÅÔ∏è Display Options</h2>
                <div class="settings-group">
                    <div class="setting-item">
                        <div class="setting-item-row">
                        <span>Show Time</span>
                        <div class="toggle-switch" id="toggle-time" onclick="toggleSetting('show_time', this)"></div>
                        </div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-item-row">
                        <span>Show Date</span>
                        <div class="toggle-switch" id="toggle-date" onclick="toggleSetting('show_date', this)"></div>
                        </div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-item-row">
                        <span>Show Temperature</span>
                        <div class="toggle-switch" id="toggle-temp" onclick="toggleSetting('show_temperature', this)"></div>
                        </div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-item-row">
                        <span>Show Weather</span>
                        <div class="toggle-switch" id="toggle-weather" onclick="toggleSetting('show_weather_code', this)"></div>
                        </div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-item-row">
                        <span>Show Filename</span>
                        <div class="toggle-switch" id="toggle-filename" onclick="toggleSetting('show_filename', this)"></div>
                        </div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-item-row">
                            <span>Show Caption</span>
                            <div class="toggle-switch" id="toggle-caption" onclick="toggleSetting('show_caption', this)"></div>
                        </div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-item-row">
                            <span>Shutdown on Display Off</span>
                            <div class="toggle-switch" id="toggle-shutdown" onclick="toggleSetting('shutdown_on_display_off', this)"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="control-card wide">
                <h2>‚öôÔ∏è Advanced Settings</h2>
                <div class="settings-group">
                    <div class="setting-item">
                        <label class="text-label" style="display: block; margin-bottom: 8px;">Location (City)</label>
                        <input type="text" id="location-city" list="location-list" placeholder="City, State, Country" 
                               onchange="updateSetting('location_city_suburb', this.value)"
                               style="width: 100%;">
                        <datalist id="location-list">
                            <!-- City only examples -->
                            <option value="Sydney">
                            <option value="Melbourne">
                            <option value="London">
                            <option value="Paris">
                            <option value="Tokyo">
                            <!-- City, Country examples -->
                            <option value="Sydney, Australia">
                            <option value="Melbourne, Australia">
                            <option value="Brisbane, Australia">
                            <option value="Perth, Australia">
                            <option value="Adelaide, Australia">
                            <option value="Canberra, Australia">
                            <option value="London, UK">
                            <option value="Manchester, UK">
                            <option value="Birmingham, UK">
                            <option value="Edinburgh, UK">
                            <option value="Toronto, Canada">
                            <option value="Vancouver, Canada">
                            <option value="Montreal, Canada">
                            <option value="Calgary, Canada">
                            <option value="Paris, France">
                            <option value="Berlin, Germany">
                            <option value="Madrid, Spain">
                            <option value="Rome, Italy">
                            <option value="Amsterdam, Netherlands">
                            <option value="Tokyo, Japan">
                            <option value="Seoul, South Korea">
                            <option value="Beijing, China">
                            <option value="Shanghai, China">
                            <option value="Bangkok, Thailand">
                            <option value="Mumbai, India">
                            <option value="Delhi, India">
                            <option value="Dubai, UAE">
                            <option value="Cairo, Egypt">
                            <option value="Johannesburg, South Africa">
                            <option value="S√£o Paulo, Brazil">
                            <option value="Rio de Janeiro, Brazil">
                            <option value="Buenos Aires, Argentina">
                            <option value="Mexico City, Mexico">
                            <!-- City, State, Country examples -->
                            <option value="New York, NY, USA">
                            <option value="Los Angeles, CA, USA">
                            <option value="Chicago, IL, USA">
                            <option value="Houston, TX, USA">
                            <option value="Phoenix, AZ, USA">
                            <option value="Philadelphia, PA, USA">
                            <option value="San Antonio, TX, USA">
                            <option value="San Diego, CA, USA">
                            <option value="Dallas, TX, USA">
                            <option value="San Jose, CA, USA">
                            <!-- Special cases -->
                            <option value="Hong Kong">
                            <option value="Singapore">
                        </datalist>
                        <small class="text-small" style="display: block; margin-top: 8px;">
                            Formats: "City", "City, Country", or "City, State, Country" (e.g. "Sydney", "Sydney, Australia", "New York, NY, USA")
                        </small>
                    </div>
                    <div class="setting-item">
                        <label class="text-label" style="display: block; margin-bottom: 8px;">Delay (seconds)</label>
                        <input type="number" id="delay-seconds" min="1" max="3600" value="30" 
                               onchange="updateSetting('delay_seconds', this.value)">
                    </div>
                    <div class="setting-item">
                        <label class="text-label" style="display: block; margin-bottom: 8px;">Display Off Time</label>
                        <input type="time" id="display-off-time" onchange="updateSetting('display_off_time', this.value)">
                    </div>
                    <div class="setting-item">
                        <label class="text-label" style="display: block; margin-bottom: 8px;">Display On Time</label>
                        <input type="time" id="display-on-time" 
                               onchange="updateSetting('display_on_time', this.value)">
                    </div>
                    <div class="setting-item">
                        <label class="text-label" style="display: block; margin-bottom: 8px;">Shutdown Countdown (seconds)</label>
                        <input type="number" id="shutdown-countdown" min="0" max="60" value="10" 
                               onchange="updateSetting('shutdown_countdown_seconds', this.value)">
                        <small class="text-small" style="display: block; margin-top: 8px;">
                            Countdown time before shutdown when "Shutdown on Display Off" is enabled
                        </small>
                    </div>
                    <div class="setting-item">
                        <label class="text-label" style="display: block; margin-bottom: 8px;">Weather Update (seconds)</label>
                        <input type="number" id="weather-update" min="60" max="3600" value="900" 
                               onchange="updateSetting('weather_update_seconds', this.value)">
                    </div>
                    <div class="setting-item">
                        <label class="text-label" style="display: block; margin-bottom: 8px;">UI Text Alpha (0-255)</label>
                        <input type="number" id="ui-text-alpha" min="0" max="255" value="192" 
                               onchange="updateSetting('ui_text_alpha', this.value)">
                    </div>
                    <div class="setting-item">
                        <label class="text-label" style="display: block; margin-bottom: 8px;">Display Correction (Horizontal)</label>
                        <input type="number" id="display-correction-horizontal" step="0.01" min="0.5" max="2.0" value="1.0" 
                               onchange="updateSetting('display_correction_horizontal', this.value)">
                        <small class="text-small">Compensate for horizontal hardware stretching (default: 1.0)</small>
                    </div>
                    <div class="setting-item">
                        <label class="text-label" style="display: block; margin-bottom: 8px;">Display Correction (Vertical)</label>
                        <input type="number" id="display-correction-vertical" step="0.01" min="0.5" max="2.0" value="1.0" 
                               onchange="updateSetting('display_correction_vertical', this.value)">
                        <small class="text-small">Compensate for vertical hardware stretching (default: 1.0)</small>
                    </div>
                    <div class="setting-item">
                        <label class="text-label" style="display: block; margin-bottom: 8px;">Color Theme</label>
                        <select id="theme-selector" onchange="changeTheme(this.value)" 
                                style="padding: 8px 12px; border: 2px solid var(--input-border); border-radius: 8px; font-size: 1em; font-family: inherit; width: 100%; box-sizing: border-box; color: var(--input-text); background: var(--bg-input);">
                            <option value="default">Default</option>
                            <option value="light">Light</option>
                            <option value="dark">Dark</option>
                            <option value="nord">Nord</option>
                            <option value="dracula">Dracula</option>
                            <option value="solarized-dark">Solarized Dark</option>
                            <option value="solarized-light">Solarized Light</option>
                            <option value="gruvbox">Gruvbox</option>
                            <option value="one-dark">One Dark</option>
                            <option value="material-dark">Material Dark</option>
                            <option value="material-light">Material Light</option>
                            <option value="high-contrast">High Contrast</option>
                            <option value="forest">Forest</option>
                            <option value="ocean">Ocean</option>
                            <option value="monochrome">Monochrome</option>
                            <option value="monokai">Monokai</option>
                            <option value="flatland">Flatland</option>
                            <option value="catppuccin-mocha">Catppuccin Mocha</option>
                            <option value="catppuccin-macchiato">Catppuccin Macchiato</option>
                            <option value="catppuccin-frappe">Catppuccin Frapp√©</option>
                            <option value="catppuccin-latte">Catppuccin Latte</option>
                        </select>
                        <small class="text-small">Choose your preferred color scheme</small>
                    </div>
                </div>
            </div>

            <div id="directoryModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Select Directory</h2>
                        <span class="close" onclick="closeDirectoryBrowser()">&times;</span>
                    </div>
                    <div id="directoryBrowser">
                        <p>Loading directories...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

        <div id="tab-system" class="tab-content">
            <div class="status-bar">
                <h2 style="margin-bottom: 15px;" class="text-accent">üíª System Resources</h2>
                <div class="status-grid">
                    <div class="status-item">
                        <div class="status-label">üíæ Free Memory</div>
                        <div class="status-value" id="status-memory">-- MB</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">‚ö° CPU Usage</div>
                        <div class="status-value" id="status-cpu">--%</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">üå°Ô∏è CPU Temperature</div>
                        <div class="status-value" id="status-cpu-temp">--¬∞C</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">üíø Free Disk Space</div>
                        <div class="status-value" id="status-disk-free">-- GB</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">üìä Disk Used</div>
                        <div class="status-value" id="status-disk-used">--%</div>
                    </div>
                </div>
            </div>

            <div class="status-bar">
                <div class="log-header">
                    <h2 style="margin: 0;" class="text-accent">üìã Logs</h2>
                    <div class="log-controls">
                        <select id="log-lines" onchange="loadLogs()" style="padding: 5px 10px; border: 2px solid var(--input-border); border-radius: 5px; color: var(--input-text); background: var(--bg-input);">
                            <option value="50">Last 50 lines</option>
                            <option value="100" selected>Last 100 lines</option>
                            <option value="200">Last 200 lines</option>
                            <option value="500">Last 500 lines</option>
                        </select>
                        <button onclick="loadLogs()" class="btn-primary" style="padding: 5px 15px;">üîÑ Refresh</button>
                    </div>
                </div>
                <div id="log-viewer" class="log-viewer">
                    Loading logs...
                </div>
            </div>

        </div>
    </div>

    <!-- Shutdown Confirmation Modal -->
    <div id="shutdownModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ö†Ô∏è Confirm Shutdown</h2>
                <span class="close" onclick="closeShutdownModal()">&times;</span>
            </div>
            <div style="padding: 20px;">
                <p style="margin-bottom: 20px;">Are you sure you want to shutdown the system?</p>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: 500; margin-bottom: 8px;">Countdown (seconds):</label>
                    <input type="number" id="shutdown-countdown-input" min="0" max="60" value="10" 
                           style="width: 100%; padding: 8px; border: 2px solid var(--input-border); border-radius: 8px; color: var(--input-text); background: var(--bg-input);">
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn-danger" style="flex: 1;" onclick="executeShutdown()">Shutdown</button>
                    <button class="btn-secondary" style="flex: 1;" onclick="closeShutdownModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Restart Confirmation Modal -->
    <div id="restartModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üîÑ Confirm Restart</h2>
                <span class="close" onclick="closeRestartModal()">&times;</span>
            </div>
            <div style="padding: 20px;">
                <p style="margin-bottom: 20px;">Are you sure you want to restart the system?</p>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: 500; margin-bottom: 8px;">Countdown (seconds):</label>
                    <input type="number" id="restart-countdown-input" min="0" max="60" value="10" 
                           style="width: 100%; padding: 8px; border: 2px solid var(--input-border); border-radius: 8px; color: var(--input-text); background: var(--bg-input);">
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn-info" style="flex: 1;" onclick="executeRestart()">Restart</button>
                    <button class="btn-secondary" style="flex: 1;" onclick="closeRestartModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Sticky Save Button -->
    <button class="sticky-save-button" onclick="saveSettingsSticky()" id="sticky-save-btn">
        üíæ Save Settings
    </button>

    <script>
        let settings = {};
        
        // Theme management
        function changeTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('piGallery-theme', theme);
            // Update selector if it exists
            const selector = document.getElementById('theme-selector');
            if (selector) {
                selector.value = theme;
            }
        }
        
        function loadTheme() {
            const savedTheme = localStorage.getItem('piGallery-theme') || 'default';
            changeTheme(savedTheme);
        }
        let isPaused = false;

        // Initialize
        let countdownInterval = null;
        let lastKnownTimeRemaining = 0;
        let lastUpdateTime = Date.now();
        
        // Power action countdown
        let powerActionCountdownInterval = null;
        let powerActionEndTime = null;
        let powerActionCompleteTimeout = null;

        document.addEventListener('DOMContentLoaded', function() {
            // Load theme first
            loadTheme();
            updateStatus();
            loadSettings();
            setInterval(updateStatus, 3000); // Update every 3 seconds
            
            // Update countdown every second
            countdownInterval = setInterval(updateCountdown, 1000);

            // Drag and drop
            const uploadArea = document.getElementById('uploadArea');
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                handleFileSelect(e.dataTransfer.files);
            });

            // Sticky save button visibility based on scroll
            setupStickySaveButton();
        });

        function setupStickySaveButton() {
            const stickyBtn = document.getElementById('sticky-save-btn');
            const controlsSection = document.querySelector('.controls');
            
            if (!stickyBtn || !controlsSection) return;
            
            // Use Intersection Observer for better performance
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        // Controls section is visible
                        stickyBtn.classList.add('visible');
                    } else {
                        // Controls section is not visible
                        stickyBtn.classList.remove('visible');
                    }
                });
            }, {
                threshold: 0.1, // Trigger when 10% of the section is visible
                rootMargin: '-100px 0px' // Account for header offset
            });
            
            observer.observe(controlsSection);
        }

        let lastImageName = '';
        let currentBrowsingField = null;
        let currentBrowsePath = '';

        async function browseDirectory(fieldId) {
            currentBrowsingField = fieldId;
            currentBrowsePath = '';
            document.getElementById('directoryModal').style.display = 'block';
            await loadDirectories('');
        }

        function closeDirectoryBrowser() {
            document.getElementById('directoryModal').style.display = 'none';
            currentBrowsingField = null;
            currentBrowsePath = '';
        }

        async function loadDirectories(path) {
            try {
                const url = path ? `/api/directories?path=${encodeURIComponent(path)}` : '/api/directories';
                const response = await fetch(url);
                const data = await response.json();
                
                if (response.ok) {
                    currentBrowsePath = data.current_path || '';
                    const browserDiv = document.getElementById('directoryBrowser');
                    
                    let html = '';
                    
                    // Show current path
                    if (currentBrowsePath) {
                        html += `<div style="margin-bottom: 15px; padding: 10px; background: var(--bg-secondary); border-radius: 5px; color: var(--text-primary);">`;
                        html += `<strong>Current Path:</strong> ${currentBrowsePath}`;
                        html += `</div>`;
                    }
                    
                    // Parent directory button
                    if (data.parent_path !== null && data.parent_path !== undefined) {
                        const escapedParent = data.parent_path.replace(/'/g, "\\'").replace(/\\/g, '\\\\');
                        html += `<div class="directory-item" onclick="loadDirectories('${escapedParent}')">`;
                        html += `<strong>.. (Parent Directory)</strong>`;
                        html += `</div>`;
                    }
                    
                    // List directories
                    if (data.directories && data.directories.length > 0) {
                        data.directories.forEach(dir => {
                            // Check if this is a Windows drive letter (e.g., "C:\")
                            const isDriveLetter = /^[A-Z]:\\?$/.test(dir);
                            
                            if (isDriveLetter) {
                                // It's a drive letter - navigate into it
                                const escapedPath = dir.replace(/'/g, "\\'").replace(/\\/g, '\\\\');
                                html += `<div class="directory-item" onclick="loadDirectories('${escapedPath}')">${dir}</div>`;
                            } else if (currentBrowsePath) {
                                // Regular directory - construct full path
                                // Determine separator based on current path format
                                let separator = '/';
                                if (currentBrowsePath.includes('\\') && !currentBrowsePath.includes('/')) {
                                    // Windows path
                                    separator = '\\';
                                }
                                
                                // Only add separator if path doesn't already end with one
                                const needsSeparator = !currentBrowsePath.endsWith('/') && !currentBrowsePath.endsWith('\\');
                                const fullPath = `${currentBrowsePath}${separator}${dir}`;
                                const escapedPath = fullPath.replace(/'/g, "\\'").replace(/\\/g, '\\\\');
                                html += `<div class="directory-item" onclick="loadDirectories('${escapedPath}')">${dir}</div>`;
                            } else {
                                // No current path - treat as full path (shouldn't happen, but handle it)
                                const escapedPath = dir.replace(/'/g, "\\'").replace(/\\/g, '\\\\');
                                html += `<div class="directory-item" onclick="loadDirectories('${escapedPath}')">${dir}</div>`;
                            }
                        });
                    } else {
                        html += `<p>No subdirectories found.</p>`;
                    }
                    
                    // Select current directory button
                    if (currentBrowsePath) {
                        const escapedPath = currentBrowsePath.replace(/'/g, "\\'").replace(/\\/g, '\\\\');
                        html += `<div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--accent-border);">`;
                        html += `<button class="btn-success btn-full" onclick="selectDirectory('${escapedPath}')">`;
                        html += `‚úì Select This Directory`;
                        html += `</button>`;
                        html += `</div>`;
                    }
                    
                    browserDiv.innerHTML = html;
                } else {
                    document.getElementById('directoryBrowser').innerHTML = 
                        `<p style="color: var(--alert-error-text);">Error: ${data.error}</p>`;
                }
            } catch (error) {
                document.getElementById('directoryBrowser').innerHTML = 
                    `<p style="color: var(--alert-error-text);">Error loading directories: ${error.message}</p>`;
            }
        }

        function selectDirectory(path) {
            if (currentBrowsingField) {
                document.getElementById(currentBrowsingField).value = path;
                updateSetting(currentBrowsingField.replace('-', '_'), path);
                closeDirectoryBrowser();
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('directoryModal');
            if (event.target == modal) {
                closeDirectoryBrowser();
            }
        }

        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            // Activate selected button
            event.target.classList.add('active');
            
            // Load logs when System tab is opened
            if (tabName === 'system') {
                loadLogs();
            }
        }

        async function loadLogs() {
            const logViewer = document.getElementById('log-viewer');
            const linesSelect = document.getElementById('log-lines');
            const lines = linesSelect ? parseInt(linesSelect.value) : 100;
            
            try {
                if (logViewer) {
                    logViewer.textContent = 'Loading logs...';
                    const response = await fetch(`/api/logs?lines=${lines}`);
                    const data = await response.json();
                    
                    if (data.status === 'ok' && data.lines) {
                        // Join log lines and display
                        logViewer.textContent = data.lines.join('\n');
                        // Auto-scroll to bottom
                        logViewer.scrollTop = logViewer.scrollHeight;
                    } else {
                        logViewer.textContent = 'No logs available';
                    }
                }
            } catch (error) {
                if (logViewer) {
                    logViewer.textContent = `Error loading logs: ${error.message}`;
                }
                console.error('Failed to load logs:', error);
            }
        }

        function updateCountdown() {
            // Don't update countdown if we don't have valid data yet
            if (lastKnownTimeRemaining === 0 && lastUpdateTime === 0) {
                return;
            }
            
            // Calculate time elapsed since last API update
            const now = Date.now();
            const elapsed = Math.floor((now - lastUpdateTime) / 1000);
            const remaining = Math.max(0, lastKnownTimeRemaining - elapsed);
            
            const countdownEl = document.getElementById('status-countdown');
            if (countdownEl && countdownEl.textContent !== 'Paused') {
                if (remaining > 0) {
                    countdownEl.textContent = `${remaining}s`;
                    countdownEl.style.color = remaining <= 5 ? '#e74c3c' : '#2ecc71'; // Red when < 5s
                } else {
                    countdownEl.textContent = '0s';
                    countdownEl.style.color = '#e74c3c';
                }
            }
        }

        async function updateStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                document.getElementById('status-time').textContent = data.time || '--:--';
                document.getElementById('status-date').textContent = data.date || '---';
                document.getElementById('status-temp').textContent = data.temperature || '--¬∞C';
                document.getElementById('status-weather').textContent = data.weather || '---';
                document.getElementById('status-index').textContent = `${data.current_index} / ${data.total_images}`;
                document.getElementById('status-paused').textContent = data.paused ? 'Paused' : 'Playing';
                document.getElementById('current-image').textContent = data.current_image || 'No image loaded';
                
                // Update countdown tracking
                if (data.time_remaining !== undefined) {
                    lastKnownTimeRemaining = data.time_remaining;
                    lastUpdateTime = Date.now();
                    
                    // Show "Paused" instead of countdown when paused
                    const countdownEl = document.getElementById('status-countdown');
                    if (data.paused && countdownEl) {
                        countdownEl.textContent = 'Paused';
                        countdownEl.style.color = '#f39c12';
                    } else {
                        updateCountdown(); // Immediately update display
                    }
                }
                
                // Update system stats if available
                if (data.system) {
                    const sys = data.system;
                    const memoryEl = document.getElementById('status-memory');
                    const cpuEl = document.getElementById('status-cpu');
                    const tempEl = document.getElementById('status-cpu-temp');
                    const diskFreeEl = document.getElementById('status-disk-free');
                    const diskUsedEl = document.getElementById('status-disk-used');
                    
                    if (memoryEl && sys.memory_free_mb !== undefined) {
                        memoryEl.textContent = `${sys.memory_free_mb} MB`;
                    }
                    if (cpuEl && sys.cpu_percent !== undefined) {
                        cpuEl.textContent = `${sys.cpu_percent}%`;
                    }
                    if (tempEl && sys.cpu_temp !== undefined) {
                        tempEl.textContent = `${sys.cpu_temp}¬∞C`;
                    }
                    if (diskFreeEl && sys.disk_free_gb !== undefined) {
                        diskFreeEl.textContent = `${sys.disk_free_gb} GB`;
                    }
                    if (diskUsedEl && sys.disk_used_percent !== undefined) {
                        diskUsedEl.textContent = `${sys.disk_used_percent}%`;
                    }
                }
                
                // Update image preview only when image changes
                const previewImg = document.getElementById('image-preview');
                if (data.current_image && data.current_image !== lastImageName) {
                    previewImg.src = `/api/image/preview?t=${Date.now()}`;
                    previewImg.style.display = 'block';
                    lastImageName = data.current_image;
                    // Load caption when image changes
                    loadCaption();
                } else if (!data.current_image) {
                    previewImg.style.display = 'none';
                    lastImageName = '';
                    // Clear caption when no image
                    document.getElementById('caption-text').value = '';
                    document.getElementById('caption-status').textContent = '';
                }
                
                isPaused = data.paused;
                document.getElementById('pauseBtn').textContent = isPaused ? '‚ñ∂Ô∏è Resume' : '‚è∏Ô∏è Pause';
            } catch (error) {
                console.error('Failed to update status:', error);
            }
        }

        async function loadSettings() {
            // Load theme selector value
            const themeSelector = document.getElementById('theme-selector');
            if (themeSelector) {
                const savedTheme = localStorage.getItem('piGallery-theme') || 'default';
                themeSelector.value = savedTheme;
            }
            try {
                const response = await fetch('/api/settings');
                settings = await response.json();
                
                // Update toggle switches
                updateToggle('toggle-time', settings.show_time === 'true');
                updateToggle('toggle-date', settings.show_date === 'true');
                updateToggle('toggle-temp', settings.show_temperature === 'true');
                updateToggle('toggle-weather', settings.show_weather_code === 'true');
                updateToggle('toggle-filename', settings.show_filename === 'true');
                updateToggle('toggle-caption', settings.show_caption === 'true');

                // Update input fields
                if (document.getElementById('delay-seconds')) {
                    document.getElementById('delay-seconds').value = settings.delay_seconds || 30;
                }
                if (document.getElementById('display-on-time')) {
                    document.getElementById('display-on-time').value = settings.display_on_time || '05:00';
                }
                if (document.getElementById('display-off-time')) {
                    document.getElementById('display-off-time').value = settings.display_off_time || '23:00';
                }
                if (document.getElementById('location-city')) {
                    document.getElementById('location-city').value = settings.location_city_suburb || '';
                }
                if (document.getElementById('ui-text-alpha')) {
                    document.getElementById('ui-text-alpha').value = settings.ui_text_alpha || 192;
                }
                if (document.getElementById('display-correction-horizontal')) {
                    document.getElementById('display-correction-horizontal').value = settings.display_correction_horizontal || 1.0;
                }
                if (document.getElementById('display-correction-vertical')) {
                    document.getElementById('display-correction-vertical').value = settings.display_correction_vertical || 1.0;
                }
                if (document.getElementById('weather-update')) {
                    document.getElementById('weather-update').value = settings.weather_update_seconds || 900;
                }
                if (document.getElementById('images-directory')) {
                    document.getElementById('images-directory').value = settings.images_directory || '';
                }
                if (document.getElementById('upload-directory')) {
                    document.getElementById('upload-directory').value = settings.upload_directory || '';
                }
                
                // Load shutdown settings
                updateToggle('toggle-shutdown', settings.shutdown_on_display_off === 'true');
                if (document.getElementById('shutdown-countdown')) {
                    document.getElementById('shutdown-countdown').value = settings.shutdown_countdown_seconds || 10;
                }
            } catch (error) {
                console.error('Failed to load settings:', error);
            }
        }

        function updateSetting(key, value) {
            settings[key] = value;
            // Optionally auto-save, or wait for "Save Settings" button
        }

        function updateToggle(id, active) {
            const element = document.getElementById(id);
            if (active) {
                element.classList.add('active');
            } else {
                element.classList.remove('active');
            }
        }

        function toggleSetting(key, element) {
            element.classList.toggle('active');
            const isActive = element.classList.contains('active');
            settings[key] = isActive ? 'true' : 'false';
        }

        async function saveSettings() {
            try {
                // Collect all settings from form
                const allSettings = {
                    ...settings,
                    delay_seconds: parseInt(document.getElementById('delay-seconds')?.value || settings.delay_seconds),
                    display_on_time: document.getElementById('display-on-time')?.value || settings.display_on_time,
                    display_off_time: document.getElementById('display-off-time')?.value || settings.display_off_time,
                    location_city_suburb: document.getElementById('location-city')?.value || settings.location_city_suburb,
                    weather_update_seconds: parseInt(document.getElementById('weather-update')?.value || settings.weather_update_seconds),
                    ui_text_alpha: parseInt(document.getElementById('ui-text-alpha')?.value || settings.ui_text_alpha),
                    display_correction_horizontal: parseFloat(document.getElementById('display-correction-horizontal')?.value || settings.display_correction_horizontal || 1.0),
                    display_correction_vertical: parseFloat(document.getElementById('display-correction-vertical')?.value || settings.display_correction_vertical || 1.0),
                    images_directory: document.getElementById('images-directory')?.value || settings.images_directory,
                    upload_directory: document.getElementById('upload-directory')?.value || settings.upload_directory,
                    shutdown_countdown_seconds: parseInt(document.getElementById('shutdown-countdown')?.value || settings.shutdown_countdown_seconds || 10),
                    save_to_config: true
                };
                
                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(allSettings)
                });
                
                if (response.ok) {
                    showAlert('Settings saved successfully!', 'success');
                } else {
                    showAlert('Failed to save settings', 'error');
                }
            } catch (error) {
                showAlert('Error saving settings: ' + error.message, 'error');
            }
        }

        async function saveSettingsSticky() {
            const btn = document.getElementById('sticky-save-btn');
            const originalText = btn.innerHTML;
            
            try {
                // Update button to show saving state
                btn.disabled = true;
                btn.innerHTML = '‚è≥ Saving...';
                
                // Call the main save function
                await saveSettings();
                
                // Show success state
                btn.classList.add('saved');
                btn.innerHTML = '‚úì Saved!';
                
                // Reset after 2 seconds
                setTimeout(() => {
                    btn.classList.remove('saved');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 2000);
            } catch (error) {
                // Reset on error
                btn.innerHTML = '‚ùå Error';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 2000);
            }
        }

        async function nextImage() {
            try {
                const response = await fetch('/api/next', { method: 'POST' });
                if (response.ok) {
                    updateStatus();
                    showAlert('Moved to next image', 'success');
                }
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            }
        }

        async function previousImage() {
            try {
                const response = await fetch('/api/prev', { method: 'POST' });
                if (response.ok) {
                    updateStatus();
                    showAlert('Moved to previous image', 'success');
                }
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            }
        }

        async function loadCaption() {
            try {
                const response = await fetch('/api/image/caption');
                if (response.ok) {
                    const data = await response.json();
                    const captionText = document.getElementById('caption-text');
                    const statusEl = document.getElementById('caption-status');
                    
                    if (data.caption) {
                        captionText.value = data.caption;
                        statusEl.textContent = 'Caption loaded from image metadata';
                        statusEl.style.color = '#28a745';
                    } else {
                        captionText.value = '';
                        statusEl.textContent = 'No caption found in image metadata';
                        statusEl.style.color = '#666';
                    }
                } else {
                    const error = await response.json();
                    document.getElementById('caption-status').textContent = 'Error: ' + (error.error || 'Failed to load caption');
                    document.getElementById('caption-status').style.color = '#dc3545';
                }
            } catch (error) {
                document.getElementById('caption-status').textContent = 'Error: ' + error.message;
                document.getElementById('caption-status').style.color = '#dc3545';
            }
        }

        async function saveCaption() {
            try {
                const captionText = document.getElementById('caption-text');
                const statusEl = document.getElementById('caption-status');
                const saveBtn = document.getElementById('save-caption-btn');
                
                const caption = captionText.value.trim();
                
                // Disable button during save
                saveBtn.disabled = true;
                saveBtn.textContent = 'üíæ Saving...';
                statusEl.textContent = 'Saving caption...';
                statusEl.style.color = '#666';
                
                const response = await fetch('/api/image/caption', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ caption: caption })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    statusEl.textContent = data.message || 'Caption saved successfully!';
                    statusEl.style.color = '#28a745';
                    showAlert('Caption saved to image metadata', 'success');
                } else {
                    const error = await response.json();
                    statusEl.textContent = 'Error: ' + (error.error || 'Failed to save caption');
                    statusEl.style.color = '#dc3545';
                    showAlert('Failed to save caption: ' + (error.error || 'Unknown error'), 'error');
                }
                
                // Re-enable button
                saveBtn.disabled = false;
                saveBtn.textContent = 'üíæ Save Caption';
            } catch (error) {
                document.getElementById('caption-status').textContent = 'Error: ' + error.message;
                document.getElementById('caption-status').style.color = '#dc3545';
                document.getElementById('save-caption-btn').disabled = false;
                document.getElementById('save-caption-btn').textContent = 'üíæ Save Caption';
                showAlert('Error saving caption: ' + error.message, 'error');
            }
        }

        async function togglePause() {
            try {
                const response = await fetch('/api/pause', { method: 'POST' });
                if (response.ok) {
                    updateStatus();
                    const data = await response.json();
                    showAlert(data.paused ? 'Slideshow paused' : 'Slideshow resumed', 'success');
                }
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            }
        }

        async function setDisplay(action) {
            try {
                const response = await fetch('/api/display', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action })
                });
                
                if (response.ok) {
                    const messages = {
                        'on': 'Display turned on',
                        'off': 'Display turned off',
                        'auto': 'Display set to auto mode'
                    };
                    showAlert(messages[action], 'success');
                    updateStatus();
                }
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            }
        }

        // Store selected files for preview
        let selectedFiles = [];

        function handleFileSelect(files) {
            // Add new files to the selection
            for (let file of files) {
                // Check if file is already in the list
                if (!selectedFiles.find(f => f.name === file.name && f.size === file.size && f.lastModified === file.lastModified)) {
                    selectedFiles.push(file);
                }
            }
            updateFilePreview();
        }

        function updateFilePreview() {
            const previewDiv = document.getElementById('uploadPreview');
            const fileListDiv = document.getElementById('fileList');
            
            if (selectedFiles.length === 0) {
                previewDiv.style.display = 'none';
                return;
            }
            
            previewDiv.style.display = 'block';
            fileListDiv.innerHTML = '';
            
            selectedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.style.cssText = 'display: flex; align-items: center; gap: 6px; padding: 6px 8px; margin-bottom: 4px; background: var(--bg-card); border-radius: 5px; border: 1px solid var(--border-divider); min-width: 0; width: 100%; box-sizing: border-box;';
                
                // Store original filename and extension
                const originalName = file.name;
                const lastDot = originalName.lastIndexOf('.');
                const baseName = lastDot > 0 ? originalName.substring(0, lastDot) : originalName;
                const extension = lastDot > 0 ? originalName.substring(lastDot) : '';
                const displayName = file.customName || originalName;
                
                const fileInfoContainer = document.createElement('div');
                fileInfoContainer.style.cssText = 'flex: 1; min-width: 0; display: flex; align-items: center; gap: 6px;';
                
                const fileInfo = document.createElement('span');
                fileInfo.style.cssText = 'flex: 1; color: var(--text-primary); font-size: 0.9em; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; min-width: 0; cursor: pointer;';
                const fileSize = (file.size / 1024 / 1024).toFixed(2);
                fileInfo.textContent = `${displayName} (${fileSize} MB)`;
                fileInfo.title = `Click to rename: ${displayName} (${fileSize} MB)`;
                
                // Make filename editable on click
                const startEdit = () => {
                    const input = document.createElement('input');
                    input.type = 'text';
                    // Use current custom name or original base name
                    const currentBaseName = file.customName ? file.customName.substring(0, file.customName.lastIndexOf('.')) : baseName;
                    input.value = currentBaseName;
                    input.style.cssText = 'flex: 1; padding: 2px 4px; border: 1px solid var(--accent-border); border-radius: 3px; font-size: 0.9em; min-width: 0; color: var(--input-text); background: var(--bg-input);';
                    input.style.width = '100%';
                    
                    const saveRename = () => {
                        const newName = input.value.trim();
                        if (newName && newName.length > 0) {
                            // Only update if name actually changed
                            const newFullName = newName + extension;
                            if (newFullName !== originalName) {
                                file.customName = newFullName;
                                fileInfo.textContent = `${file.customName} (${fileSize} MB)`;
                                fileInfo.title = `Click to rename: ${file.customName} (${fileSize} MB)`;
                            } else {
                                // Reverted to original, clear custom name
                                file.customName = null;
                                fileInfo.textContent = `${originalName} (${fileSize} MB)`;
                                fileInfo.title = `Click to rename: ${originalName} (${fileSize} MB)`;
                            }
                        } else {
                            // Empty name, revert to original
                            file.customName = null;
                            fileInfo.textContent = `${originalName} (${fileSize} MB)`;
                            fileInfo.title = `Click to rename: ${originalName} (${fileSize} MB)`;
                        }
                        fileInfoContainer.replaceChild(fileInfo, input);
                        // Re-attach click handler
                        fileInfo.onclick = startEdit;
                    };
                    
                    const cancelRename = () => {
                        fileInfoContainer.replaceChild(fileInfo, input);
                        // Re-attach click handler
                        fileInfo.onclick = startEdit;
                    };
                    
                    input.onblur = saveRename;
                    input.onkeydown = (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            saveRename();
                        } else if (e.key === 'Escape') {
                            e.preventDefault();
                            cancelRename();
                        }
                    };
                    
                    fileInfoContainer.replaceChild(input, fileInfo);
                    input.focus();
                    input.select();
                };
                
                fileInfo.onclick = startEdit;
                
                const removeBtn = document.createElement('button');
                removeBtn.textContent = '√ó';
                removeBtn.style.cssText = 'background: var(--alert-error-border); color: var(--btn-text); border: none; border-radius: 2px; padding: 0; margin: 0; cursor: pointer; font-size: 12px; font-weight: bold; flex-shrink: 0; width: 16px !important; height: 16px !important; min-width: 16px !important; max-width: 16px !important; line-height: 1; display: inline-flex; align-items: center; justify-content: center; box-sizing: border-box;';
                removeBtn.title = 'Remove file';
                removeBtn.onclick = () => {
                    selectedFiles.splice(index, 1);
                    updateFilePreview();
                };
                
                fileInfoContainer.appendChild(fileInfo);
                fileItem.appendChild(fileInfoContainer);
                fileItem.appendChild(removeBtn);
                fileListDiv.appendChild(fileItem);
            });
        }

        function clearFileSelection() {
            selectedFiles = [];
            document.getElementById('fileInput').value = '';
            const captionInput = document.getElementById('upload-caption');
            if (captionInput) {
                captionInput.value = '';
            }
            updateFilePreview();
            document.getElementById('uploadStatus').innerHTML = '';
        }

        async function uploadSelectedFiles() {
            if (selectedFiles.length === 0) {
                showAlert('No files selected', 'error');
                return;
            }

            const uploadStatus = document.getElementById('uploadStatus');
            const uploadBtn = document.getElementById('uploadBtn');
            uploadStatus.innerHTML = '';

            // Disable upload button during upload
            uploadBtn.disabled = true;
            uploadBtn.textContent = '‚è≥ Uploading...';

            // Get caption from input field (applies to all files)
            const captionInput = document.getElementById('upload-caption');
            const caption = captionInput ? captionInput.value.trim() : '';

            let successCount = 0;
            let failCount = 0;

            for (let file of selectedFiles) {
                const formData = new FormData();
                // Use custom name if set, otherwise use original filename
                const fileName = file.customName || file.name;
                // Create a new File object with the custom name if renamed
                const fileToUpload = file.customName ? new File([file], fileName, { type: file.type, lastModified: file.lastModified }) : file;
                formData.append('file', fileToUpload);
                if (caption) {
                    formData.append('caption', caption);
                }

                try {
                    uploadStatus.innerHTML += `<p>Uploading ${file.name}...</p>`;
                    const response = await fetch('/api/upload', {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const captionMsg = caption ? ' with caption' : '';
                        uploadStatus.innerHTML += `<p style="color: var(--alert-success-text);">‚úÖ ${file.name} uploaded successfully${captionMsg}!</p>`;
                        successCount++;
                    } else {
                        const data = await response.json();
                        uploadStatus.innerHTML += `<p style="color: var(--alert-error-text);">‚ùå ${file.name}: ${data.error}</p>`;
                        failCount++;
                    }
                } catch (error) {
                    uploadStatus.innerHTML += `<p style="color: var(--alert-error-text);">‚ùå ${file.name}: ${error.message}</p>`;
                    failCount++;
                }
            }

            // Re-enable upload button
            uploadBtn.disabled = false;
            uploadBtn.textContent = 'üì§ Upload All';

            // Show summary
            if (successCount > 0) {
                showAlert(`Successfully uploaded ${successCount} file(s)${failCount > 0 ? `, ${failCount} failed` : ''}`, failCount > 0 ? 'error' : 'success');
            } else {
                showAlert('Upload failed for all files', 'error');
            }

            // Clear selection after successful upload
            if (failCount === 0) {
                clearFileSelection();
            }
            
            // Refresh status after upload
            setTimeout(updateStatus, 1000);
        }

        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = `alert ${type}`;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 3000);
        }

        function showFullImage() {
            const modal = document.getElementById('imageModal');
            const fullImg = document.getElementById('full-image');
            const previewImg = document.getElementById('image-preview');
            
            if (previewImg.src) {
                // Use the full image endpoint
                fullImg.src = `/api/image/full?t=${Date.now()}`;
                modal.style.display = 'block';
            }
        }

        function closeFullImage(event) {
            const modal = document.getElementById('imageModal');
            // Close if clicking on the background or the close button
            if (event.target === modal || event.target.classList.contains('image-modal-close')) {
                modal.style.display = 'none';
            }
        }

        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('imageModal');
                if (modal.style.display === 'block') {
                    modal.style.display = 'none';
                }
                // Close power management modals too
                const shutdownModal = document.getElementById('shutdownModal');
                const restartModal = document.getElementById('restartModal');
                if (shutdownModal && shutdownModal.style.display === 'block') {
                    closeShutdownModal();
                }
                if (restartModal && restartModal.style.display === 'block') {
                    closeRestartModal();
                }
            }
        });

        // Shutdown modal functions
        function confirmShutdown() {
            document.getElementById('shutdownModal').style.display = 'block';
        }

        function closeShutdownModal() {
            document.getElementById('shutdownModal').style.display = 'none';
        }

        async function executeShutdown() {
            const countdown = parseInt(document.getElementById('shutdown-countdown-input').value) || 10;
            
            try {
                const response = await fetch('/api/system/shutdown', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ countdown: countdown })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    closeShutdownModal();
                    showAlert(`System shutting down in ${countdown} seconds...`, 'success');
                    
                    // Start countdown timer
                    startPowerActionCountdown(countdown, 'Shutting down');
                    
                    // Hide cancel button after countdown
                    powerActionCompleteTimeout = setTimeout(() => {
                        stopPowerActionCountdown();
                        hidePowerActionStatus();
                        showAlert('System shutdown initiated. Connection will be lost.', 'error');
                        powerActionCompleteTimeout = null;
                    }, countdown * 1000);
                } else if (response.status === 409) {
                    // Power action already in progress
                    const error = await response.json();
                    closeShutdownModal();
                    showAlert(error.error || 'A power action is already in progress', 'error');
                } else {
                    const error = await response.json();
                    showAlert('Shutdown failed: ' + (error.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                showAlert('Error initiating shutdown: ' + error.message, 'error');
            }
        }

        // Restart modal functions
        function confirmRestart() {
            document.getElementById('restartModal').style.display = 'block';
        }

        function closeRestartModal() {
            document.getElementById('restartModal').style.display = 'none';
        }

        async function executeRestart() {
            const countdown = parseInt(document.getElementById('restart-countdown-input').value) || 10;
            
            try {
                const response = await fetch('/api/system/restart', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ countdown: countdown })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    closeRestartModal();
                    showAlert(`System restarting in ${countdown} seconds...`, 'success');
                    
                    // Start countdown timer
                    startPowerActionCountdown(countdown, 'Restarting');
                    
                    // Hide cancel button and show reconnection message
                    powerActionCompleteTimeout = setTimeout(() => {
                        stopPowerActionCountdown();
                        hidePowerActionStatus();
                        showAlert('System restarting. Page will reload when system comes back online.', 'error');
                        
                        // Try to reconnect after estimated restart time (30 seconds boot time)
                        const reconnectTime = 30 * 1000;
                        setTimeout(() => {
                            location.reload();
                        }, reconnectTime);
                        powerActionCompleteTimeout = null;
                    }, countdown * 1000);
                } else if (response.status === 409) {
                    // Power action already in progress
                    const error = await response.json();
                    closeRestartModal();
                    showAlert(error.error || 'A power action is already in progress', 'error');
                } else {
                    const error = await response.json();
                    showAlert('Restart failed: ' + (error.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                showAlert('Error initiating restart: ' + error.message, 'error');
            }
        }

        // Close modals when clicking outside
        window.addEventListener('click', function(event) {
            const shutdownModal = document.getElementById('shutdownModal');
            const restartModal = document.getElementById('restartModal');
            if (event.target === shutdownModal) {
                closeShutdownModal();
            }
            if (event.target === restartModal) {
                closeRestartModal();
            }
        });

        // Power action status functions
        function showPowerActionStatus(message) {
            const statusDiv = document.getElementById('power-action-status');
            const messageSpan = document.getElementById('power-action-message');
            messageSpan.textContent = message;
            statusDiv.style.display = 'block';
        }

        function hidePowerActionStatus() {
            const statusDiv = document.getElementById('power-action-status');
            statusDiv.style.display = 'none';
        }

        function startPowerActionCountdown(seconds, actionName) {
            // Set end time
            powerActionEndTime = Date.now() + (seconds * 1000);
            
            // Initial display
            updatePowerActionCountdown(actionName);
            
            // Update every second
            powerActionCountdownInterval = setInterval(() => {
                updatePowerActionCountdown(actionName);
            }, 1000);
        }

        function updatePowerActionCountdown(actionName) {
            if (!powerActionEndTime) return;
            
            const remaining = Math.max(0, Math.ceil((powerActionEndTime - Date.now()) / 1000));
            
            if (remaining > 0) {
                showPowerActionStatus(`‚è≥ ${actionName} in ${remaining} second${remaining !== 1 ? 's' : ''}...`);
            } else {
                showPowerActionStatus(`‚è≥ ${actionName} now...`);
            }
        }

        function stopPowerActionCountdown() {
            if (powerActionCountdownInterval) {
                clearInterval(powerActionCountdownInterval);
                powerActionCountdownInterval = null;
            }
            if (powerActionCompleteTimeout) {
                clearTimeout(powerActionCompleteTimeout);
                powerActionCompleteTimeout = null;
            }
            powerActionEndTime = null;
        }

        async function cancelPowerAction() {
            try {
                const response = await fetch('/api/system/cancel', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    stopPowerActionCountdown();
                    hidePowerActionStatus();
                    showAlert('Power action cancelled successfully', 'success');
                } else {
                    const error = await response.json();
                    showAlert('Cancel failed: ' + (error.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                showAlert('Error cancelling power action: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>

