<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Frame Control</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .tab-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
        }

        .tab-button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 12px 24px;
            font-size: 1.1em;
            font-weight: 500;
            cursor: pointer;
            border-radius: 10px 10px 0 0;
            transition: all 0.3s;
            margin-bottom: -2px;
        }

        .tab-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .tab-button.active {
            background: white;
            color: #667eea;
            border-bottom: 2px solid white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .status-bar {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .status-item {
            text-align: center;
        }

        .status-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        .status-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .control-card.wide {
            max-width: 500px;
        }

        @media (max-width: 768px) {
            .control-card.wide {
                max-width: 100%;
            }
        }

        .control-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden; /* Prevent content from overflowing */
            box-sizing: border-box;
            width: 100%;
            max-width: 100%;
        }

        .control-card h2 {
            font-size: 1.3em;
            margin-bottom: 20px;
            color: #667eea;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        button {
            flex: 1;
            min-width: 120px;
            padding: 15px 25px;
            font-size: 1.1em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }

        button:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-full {
            width: 100%;
        }

        .upload-area {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .upload-area:hover {
            background: #f8f9ff;
            border-color: #764ba2;
        }

        .upload-area.dragover {
            background: #f0f0ff;
            border-color: #764ba2;
            transform: scale(1.02);
        }

        input[type="file"] {
            display: none;
        }

        .settings-group {
            margin-bottom: 20px;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            overflow: hidden; /* Prevent overflow */
        }

        .setting-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            overflow: visible; /* Allow content to be visible */
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-item-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            max-width: 100%;
            gap: 10px;
            box-sizing: border-box;
            overflow: hidden; /* Prevent overflow */
        }

        .setting-item-row > span {
            font-weight: 500;
            color: #333;
            flex: 1 1 auto;
            min-width: 0;
            flex-shrink: 0;
            overflow: visible;
            white-space: nowrap;
        }

        .setting-item-complex {
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 100%;
        }

        .setting-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            flex: 1 1 0;
            min-width: 0;
            max-width: 100%;
            width: 100%;
            box-sizing: border-box;
            overflow: visible; /* Allow content to be visible */
        }

        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: #ccc;
            border-radius: 15px;
            cursor: pointer;
            transition: background 0.3s;
            flex-shrink: 0; /* Don't shrink toggle switches */
        }

        .toggle-switch.active {
            background: #667eea;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: left 0.3s;
        }

        .toggle-switch.active::after {
            left: 33px;
        }

        input[type="text"] {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            font-family: inherit;
            width: 140px;
            box-sizing: border-box;
            color: #333;
            background: #fff;
            text-align: left;
            margin: 0;
        }

        input[type="number"] {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            font-family: inherit;
            width: 140px;
            box-sizing: border-box;
            color: #333;
            background: #fff;
            text-align: center;
            margin: 0;
        }

        input[type="text"]#location-city {
            width: 100%;
            margin: 0;
            text-align: left;
        }

        input[type="time"] {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            font-family: inherit;
            width: 140px;
            box-sizing: border-box;
            color: #333;
            background: #fff;
            text-align: left;
            margin: 0;
        }

        input[type="number"]:focus,
        input[type="time"]:focus,
        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .browse-button {
            padding: 0;
            background: transparent;
            color: #667eea;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.2em;
            width: 28px;
            height: 28px;
            min-width: 28px;
            max-width: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 0 0 28px;
            transition: opacity 0.3s;
            box-sizing: border-box;
            line-height: 1;
            margin-top: 3px;
        }

        .browse-button:hover {
            opacity: 0.7;
        }

        .browse-button:active {
            transform: scale(0.95);
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 15px;
            width: 80%;
            max-width: 600px;
            max-height: 70vh;
            overflow: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .directory-list {
            list-style: none;
            padding: 0;
        }

        .directory-item {
            padding: 10px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .directory-item:hover {
            background: #e9ecef;
        }

        .directory-item::before {
            content: 'üìÅ';
            font-size: 1.2em;
        }

        .current-image {
            font-size: 1em;
            color: #666;
            word-break: break-all;
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .image-preview-container {
            margin-top: 20px;
            text-align: center;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
        }

        .playback-controls-below-preview {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .playback-controls-below-preview button {
            flex: 0 0 auto;
            min-width: 120px;
        }

        #image-preview {
            max-width: 100%;
            max-height: 400px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            object-fit: contain;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        #image-preview:hover {
            transform: scale(1.02);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .image-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            overflow: auto;
        }

        .image-modal-content {
            position: relative;
            margin: auto;
            padding: 20px;
            width: 90%;
            max-width: 90%;
            height: 90%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-modal img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 10px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
        }

        .image-modal-close {
            position: absolute;
            top: 20px;
            right: 40px;
            color: #fff;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }

        .image-modal-close:hover {
            color: #667eea;
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 1.8em;
            }

            .status-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .controls {
                grid-template-columns: 1fr;
            }

            .control-card {
                width: 100%;
                max-width: 100%;
            }

            .setting-item-row {
                flex-wrap: nowrap;
            }

            .setting-item-row > span {
                flex: 1 1 auto;
                min-width: 0;
                font-size: 0.9em;
            }

            .toggle-switch {
                flex-shrink: 0;
            }

            .setting-controls {
                width: 100%;
            }

            button {
                min-width: 100px;
                padding: 12px 20px;
                font-size: 1em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üñºÔ∏è piGallery Web Control</h1>
            <p>Control the piGallery from anywhere on the network</p>
        </header>

        <div class="alert" id="alert"></div>

        <div class="tab-container">
            <button class="tab-button active" onclick="switchTab('status')">üìä Status</button>
            <button class="tab-button" onclick="switchTab('system')">üíª System</button>
        </div>

        <div id="tab-status" class="tab-content active">
        <div class="status-bar">
            <h2 style="margin-bottom: 15px; color: #667eea;">üìä Current Device Status</h2>
            <div class="status-grid">
                <div class="status-item">
                    <div class="status-label">‚è∞ Time</div>
                    <div class="status-value" id="status-time">--:--</div>
                </div>
                <div class="status-item">
                    <div class="status-label">üìÖ Date</div>
                    <div class="status-value" id="status-date">---</div>
                </div>
                <div class="status-item">
                    <div class="status-label">üå°Ô∏è Temperature</div>
                    <div class="status-value" id="status-temp">--¬∞C</div>
                </div>
                <div class="status-item">
                    <div class="status-label">‚òÅÔ∏è Weather</div>
                    <div class="status-value" id="status-weather">---</div>
                </div>
                <div class="status-item">
                    <div class="status-label">üì∏ Image</div>
                    <div class="status-value" id="status-index">- / -</div>
                </div>
                <div class="status-item">
                    <div class="status-label">‚ñ∂Ô∏è State</div>
                    <div class="status-value" id="status-paused">Playing</div>
                </div>
            </div>
            <div class="image-preview-container">
                <h3 style="margin-bottom: 15px; color: #667eea; font-size: 1.1em;">üì∏ Current Image</h3>
                <div class="current-image-info" id="current-image" style="margin-bottom: 15px; color: #666; font-size: 0.95em;">No image loaded</div>
                <div style="display: flex; justify-content: center; align-items: center; width: 100%;">
                    <img id="image-preview" src="" alt="Current image preview" 
                         style="max-width: 100%; max-height: 400px; border-radius: 10px; 
                                box-shadow: 0 4px 15px rgba(0,0,0,0.2); display: none;"
                         onclick="showFullImage()" title="Click to view full-size image">
                </div>
                <div class="playback-controls-below-preview">
                    <button class="btn-primary" onclick="previousImage()">‚¨ÖÔ∏è Previous</button>
                    <button class="btn-warning" onclick="togglePause()" id="pauseBtn">‚è∏Ô∏è Pause</button>
                    <button class="btn-primary" onclick="nextImage()">Next ‚û°Ô∏è</button>
                </div>
            </div>

            <div class="caption-editor-container" style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px; border: 1px solid #e0e0e0;">
                <h3 style="margin-bottom: 15px; color: #667eea; font-size: 1.1em;">‚úèÔ∏è Image Caption</h3>
                <div style="margin-bottom: 10px;">
                    <textarea id="caption-text" placeholder="Enter caption for this image (saved to image metadata)..." 
                              style="width: 100%; min-height: 100px; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 0.95em; font-family: inherit; resize: vertical; box-sizing: border-box;"></textarea>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button class="btn-success" onclick="saveCaption()" id="save-caption-btn">üíæ Save Caption</button>
                    <button class="btn-secondary" onclick="loadCaption()" id="load-caption-btn">üîÑ Reload</button>
                    <span id="caption-status" style="color: #666; font-size: 0.9em; margin-left: 10px;"></span>
                </div>
            </div>

            <div id="imageModal" class="image-modal" onclick="closeFullImage(event)">
                <span class="image-modal-close">&times;</span>
                <div class="image-modal-content">
                    <img id="full-image" src="" alt="Full-size image">
                </div>
            </div>
        </div>

        <div class="controls">

            <div class="control-card">
                <h2>üí° Display Control</h2>
                <div class="button-group">
                    <button class="btn-success" onclick="setDisplay('on')">Turn On</button>
                    <button class="btn-danger" onclick="setDisplay('off')">Turn Off</button>
                </div>
                <button class="btn-primary btn-full" onclick="setDisplay('auto')">üîÑ Auto Mode</button>
            </div>

            <div class="control-card">
                <h2>üì§ Upload Photos</h2>
                <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                    <p style="font-size: 1.2em; margin-bottom: 10px;">üìÅ Click or Drop Files Here</p>
                    <p style="color: #666;">JPG, JPEG, PNG supported</p>
                    <input type="file" id="fileInput" accept="image/jpeg,image/jpg,image/png" multiple onchange="handleFileSelect(this.files)">
                </div>
                
                <div id="uploadPreview" style="display: none; margin-top: 20px;">
                    <h3 style="font-size: 1.1em; color: #667eea; margin-bottom: 15px;">üìã Files Ready to Upload</h3>
                    <div id="fileList" style="margin-bottom: 15px; max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 8px; background: #f8f9fa; width: 100%; box-sizing: border-box;"></div>
                    
                    <div style="margin-top: 15px;">
                        <label style="display: block; font-weight: 500; color: #333; margin-bottom: 8px;">‚úèÔ∏è Caption (optional - applies to all uploaded files)</label>
                        <textarea id="upload-caption" placeholder="Enter a caption to add to all uploaded photos..." 
                                  style="width: 100%; min-height: 60px; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 0.95em; font-family: inherit; resize: vertical; box-sizing: border-box;"></textarea>
                    </div>
                    
                    <div style="margin-top: 15px; display: flex; gap: 8px; justify-content: center;">
                        <button class="btn-success" onclick="uploadSelectedFiles()" id="uploadBtn" style="padding: 8px 16px; font-size: 0.9em;">üì§ Upload All</button>
                        <button class="btn-secondary" onclick="clearFileSelection()" style="padding: 8px 16px; font-size: 0.9em;">üóëÔ∏è Clear</button>
                    </div>
                </div>
                
                <div id="uploadStatus" style="margin-top: 15px;"></div>
                
                <div style="margin-top: 25px; padding-top: 25px; border-top: 1px solid #eee;">
                    <h3 style="font-size: 1.3em; color: #667eea; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #667eea;">üìÅ Directories</h3>
                    <div class="settings-group">
                        <div class="setting-item">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <label style="font-weight: 500; color: #333; flex: 1;">Images Directory</label>
                                <button onclick="browseDirectory('images-directory')" class="browse-button" 
                                        title="Browse for directory">
                                    üìÅ
                                </button>
                            </div>
                            <input type="text" id="images-directory" placeholder="/path/to/images" 
                                   onchange="updateSetting('images_directory', this.value)"
                                   title="Click to edit or use browse button"
                                   style="width: 100%; padding: 8px 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em; color: #333; background: #fff; box-sizing: border-box; text-align: left;">
                        </div>
                        <div class="setting-item">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <label style="font-weight: 500; color: #333; flex: 1;">Upload Directory</label>
                                <button onclick="browseDirectory('upload-directory')" class="browse-button"
                                        title="Browse for directory">
                                    üìÅ
                                </button>
                            </div>
                            <input type="text" id="upload-directory" placeholder="Leave empty for default" 
                                   onchange="updateSetting('upload_directory', this.value)"
                                   title="Click to edit or use browse button"
                                   style="width: 100%; padding: 8px 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em; color: #333; background: #fff; box-sizing: border-box; text-align: left;">
                            <small style="display: block; color: #666; margin-top: 8px;">
                                default: [ImagesDirectory]/uploaded/
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="control-card">
                <h2>üëÅÔ∏è Display Options</h2>
                <div class="settings-group">
                    <div class="setting-item">
                        <div class="setting-item-row">
                            <span>Show Time</span>
                            <div class="toggle-switch" id="toggle-time" onclick="toggleSetting('show_time', this)"></div>
                        </div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-item-row">
                            <span>Show Date</span>
                            <div class="toggle-switch" id="toggle-date" onclick="toggleSetting('show_date', this)"></div>
                        </div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-item-row">
                            <span>Show Temperature</span>
                            <div class="toggle-switch" id="toggle-temp" onclick="toggleSetting('show_temperature', this)"></div>
                        </div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-item-row">
                            <span>Show Weather</span>
                            <div class="toggle-switch" id="toggle-weather" onclick="toggleSetting('show_weather_code', this)"></div>
                        </div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-item-row">
                            <span>Show Filename</span>
                            <div class="toggle-switch" id="toggle-filename" onclick="toggleSetting('show_filename', this)"></div>
                        </div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-item-row">
                            <span>Show Caption</span>
                            <div class="toggle-switch" id="toggle-caption" onclick="toggleSetting('show_caption', this)"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="control-card wide">
                <h2>‚öôÔ∏è Advanced Settings</h2>
                <div class="settings-group">
                    <div class="setting-item">
                        <label style="display: block; font-weight: 500; color: #333; margin-bottom: 8px;">Location (City)</label>
                        <input type="text" id="location-city" list="location-list" placeholder="City, State, Country" 
                               onchange="updateSetting('location_city_suburb', this.value)"
                               style="width: 100%;">
                        <datalist id="location-list">
                            <!-- City only examples -->
                            <option value="Sydney">
                            <option value="Melbourne">
                            <option value="London">
                            <option value="Paris">
                            <option value="Tokyo">
                            <!-- City, Country examples -->
                            <option value="Sydney, Australia">
                            <option value="Melbourne, Australia">
                            <option value="Brisbane, Australia">
                            <option value="Perth, Australia">
                            <option value="Adelaide, Australia">
                            <option value="Canberra, Australia">
                            <option value="London, UK">
                            <option value="Manchester, UK">
                            <option value="Birmingham, UK">
                            <option value="Edinburgh, UK">
                            <option value="Toronto, Canada">
                            <option value="Vancouver, Canada">
                            <option value="Montreal, Canada">
                            <option value="Calgary, Canada">
                            <option value="Paris, France">
                            <option value="Berlin, Germany">
                            <option value="Madrid, Spain">
                            <option value="Rome, Italy">
                            <option value="Amsterdam, Netherlands">
                            <option value="Tokyo, Japan">
                            <option value="Seoul, South Korea">
                            <option value="Beijing, China">
                            <option value="Shanghai, China">
                            <option value="Bangkok, Thailand">
                            <option value="Mumbai, India">
                            <option value="Delhi, India">
                            <option value="Dubai, UAE">
                            <option value="Cairo, Egypt">
                            <option value="Johannesburg, South Africa">
                            <option value="S√£o Paulo, Brazil">
                            <option value="Rio de Janeiro, Brazil">
                            <option value="Buenos Aires, Argentina">
                            <option value="Mexico City, Mexico">
                            <!-- City, State, Country examples -->
                            <option value="New York, NY, USA">
                            <option value="Los Angeles, CA, USA">
                            <option value="Chicago, IL, USA">
                            <option value="Houston, TX, USA">
                            <option value="Phoenix, AZ, USA">
                            <option value="Philadelphia, PA, USA">
                            <option value="San Antonio, TX, USA">
                            <option value="San Diego, CA, USA">
                            <option value="Dallas, TX, USA">
                            <option value="San Jose, CA, USA">
                            <!-- Special cases -->
                            <option value="Hong Kong">
                            <option value="Singapore">
                        </datalist>
                        <small style="display: block; color: #666; margin-top: 8px;">
                            Formats: "City", "City, Country", or "City, State, Country" (e.g. "Sydney", "Sydney, Australia", "New York, NY, USA")
                        </small>
                    </div>
                    <div class="setting-item">
                        <label style="display: block; font-weight: 500; color: #333; margin-bottom: 8px;">Delay (seconds)</label>
                        <input type="number" id="delay-seconds" min="1" max="3600" value="30" 
                               onchange="updateSetting('delay_seconds', this.value)">
                    </div>
                    <div class="setting-item">
                        <label style="display: block; font-weight: 500; color: #333; margin-bottom: 8px;">Display On Time</label>
                        <input type="time" id="display-on-time" 
                               onchange="updateSetting('display_on_time', this.value)">
                    </div>
                    <div class="setting-item">
                        <label style="display: block; font-weight: 500; color: #333; margin-bottom: 8px;">Display Off Time</label>
                        <input type="time" id="display-off-time" 
                               onchange="updateSetting('display_off_time', this.value)">
                    </div>
                    <div class="setting-item">
                        <label style="display: block; font-weight: 500; color: #333; margin-bottom: 8px;">Weather Update (seconds)</label>
                        <input type="number" id="weather-update" min="60" max="3600" value="900" 
                               onchange="updateSetting('weather_update_seconds', this.value)">
                    </div>
                    <div class="setting-item">
                        <label style="display: block; font-weight: 500; color: #333; margin-bottom: 8px;">UI Text Alpha (0-255)</label>
                        <input type="number" id="ui-text-alpha" min="0" max="255" value="192" 
                               onchange="updateSetting('ui_text_alpha', this.value)">
                    </div>
                    <div class="setting-item">
                        <label style="display: block; font-weight: 500; color: #333; margin-bottom: 8px;">Aspect Ratio (Landscape)</label>
                        <input type="number" id="aspect-landscape" step="0.1" min="0.5" max="3.0" value="1.5" 
                               onchange="updateSetting('aspect_ratio_landscape', this.value)">
                    </div>
                    <div class="setting-item">
                        <label style="display: block; font-weight: 500; color: #333; margin-bottom: 8px;">Aspect Ratio (Portrait)</label>
                        <input type="number" id="aspect-portrait" step="0.1" min="0.1" max="1.0" value="0.667" 
                               onchange="updateSetting('aspect_ratio_portrait', this.value)">
                    </div>
                </div>
                <button class="btn-success btn-full" onclick="saveSettings()">üíæ Save Settings</button>
            </div>

            <div id="directoryModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Select Directory</h2>
                        <span class="close" onclick="closeDirectoryBrowser()">&times;</span>
                    </div>
                    <div id="directoryBrowser">
                        <p>Loading directories...</p>
                    </div>
                </div>
            </div>
        </div>
        </div>

        <div id="tab-system" class="tab-content">
            <div class="status-bar">
                <h2 style="margin-bottom: 15px; color: #667eea;">üíª System Resources</h2>
                <div class="status-grid">
                    <div class="status-item">
                        <div class="status-label">üíæ Free Memory</div>
                        <div class="status-value" id="status-memory">-- MB</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">‚ö° CPU Usage</div>
                        <div class="status-value" id="status-cpu">--%</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">üå°Ô∏è CPU Temperature</div>
                        <div class="status-value" id="status-cpu-temp">--¬∞C</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">üíø Free Disk Space</div>
                        <div class="status-value" id="status-disk-free">-- GB</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">üìä Disk Used</div>
                        <div class="status-value" id="status-disk-used">--%</div>
                    </div>
                </div>
            </div>

            <div class="status-bar">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 style="margin: 0; color: #667eea;">üìã Application Logs</h2>
                    <div style="display: flex; gap: 10px;">
                        <select id="log-lines" onchange="loadLogs()" style="padding: 5px 10px; border: 2px solid #ddd; border-radius: 5px;">
                            <option value="50">Last 50 lines</option>
                            <option value="100" selected>Last 100 lines</option>
                            <option value="200">Last 200 lines</option>
                            <option value="500">Last 500 lines</option>
                        </select>
                        <button onclick="loadLogs()" class="btn-primary" style="padding: 5px 15px;">üîÑ Refresh</button>
                    </div>
                </div>
                <div id="log-viewer" style="background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 0.9em; max-height: 500px; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word;">
                    Loading logs...
                </div>
            </div>
        </div>
    </div>

    <script>
        let settings = {};
        let isPaused = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus();
            loadSettings();
            setInterval(updateStatus, 3000); // Update every 3 seconds

            // Drag and drop
            const uploadArea = document.getElementById('uploadArea');
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                handleFileSelect(e.dataTransfer.files);
            });
        });

        let lastImageName = '';
        let currentBrowsingField = null;
        let currentBrowsePath = '';

        async function browseDirectory(fieldId) {
            currentBrowsingField = fieldId;
            currentBrowsePath = '';
            document.getElementById('directoryModal').style.display = 'block';
            await loadDirectories('');
        }

        function closeDirectoryBrowser() {
            document.getElementById('directoryModal').style.display = 'none';
            currentBrowsingField = null;
            currentBrowsePath = '';
        }

        async function loadDirectories(path) {
            try {
                const url = path ? `/api/directories?path=${encodeURIComponent(path)}` : '/api/directories';
                const response = await fetch(url);
                const data = await response.json();
                
                if (response.ok) {
                    currentBrowsePath = data.current_path || '';
                    const browserDiv = document.getElementById('directoryBrowser');
                    
                    let html = '';
                    
                    // Show current path
                    if (currentBrowsePath) {
                        html += `<div style="margin-bottom: 15px; padding: 10px; background: #f0f0f0; border-radius: 5px;">`;
                        html += `<strong>Current Path:</strong> ${currentBrowsePath}`;
                        html += `</div>`;
                    }
                    
                    // Parent directory button
                    if (data.parent_path !== null && data.parent_path !== undefined) {
                        const escapedParent = data.parent_path.replace(/'/g, "\\'").replace(/\\/g, '\\\\');
                        html += `<div class="directory-item" onclick="loadDirectories('${escapedParent}')">`;
                        html += `<strong>.. (Parent Directory)</strong>`;
                        html += `</div>`;
                    }
                    
                    // List directories
                    if (data.directories && data.directories.length > 0) {
                        data.directories.forEach(dir => {
                            // Check if this is a Windows drive letter (e.g., "C:\")
                            const isDriveLetter = /^[A-Z]:\\?$/.test(dir);
                            
                            if (isDriveLetter) {
                                // It's a drive letter - navigate into it
                                const escapedPath = dir.replace(/'/g, "\\'").replace(/\\/g, '\\\\');
                                html += `<div class="directory-item" onclick="loadDirectories('${escapedPath}')">${dir}</div>`;
                            } else if (currentBrowsePath) {
                                // Regular directory - construct full path
                                // Determine separator based on current path format
                                let separator = '/';
                                if (currentBrowsePath.includes('\\') && !currentBrowsePath.includes('/')) {
                                    // Windows path
                                    separator = '\\';
                                }
                                
                                // Only add separator if path doesn't already end with one
                                const needsSeparator = !currentBrowsePath.endsWith('/') && !currentBrowsePath.endsWith('\\');
                                const fullPath = `${currentBrowsePath}${separator}${dir}`;
                                const escapedPath = fullPath.replace(/'/g, "\\'").replace(/\\/g, '\\\\');
                                html += `<div class="directory-item" onclick="loadDirectories('${escapedPath}')">${dir}</div>`;
                            } else {
                                // No current path - treat as full path (shouldn't happen, but handle it)
                                const escapedPath = dir.replace(/'/g, "\\'").replace(/\\/g, '\\\\');
                                html += `<div class="directory-item" onclick="loadDirectories('${escapedPath}')">${dir}</div>`;
                            }
                        });
                    } else {
                        html += `<p>No subdirectories found.</p>`;
                    }
                    
                    // Select current directory button
                    if (currentBrowsePath) {
                        const escapedPath = currentBrowsePath.replace(/'/g, "\\'").replace(/\\/g, '\\\\');
                        html += `<div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #667eea;">`;
                        html += `<button class="btn-success btn-full" onclick="selectDirectory('${escapedPath}')">`;
                        html += `‚úì Select This Directory`;
                        html += `</button>`;
                        html += `</div>`;
                    }
                    
                    browserDiv.innerHTML = html;
                } else {
                    document.getElementById('directoryBrowser').innerHTML = 
                        `<p style="color: red;">Error: ${data.error}</p>`;
                }
            } catch (error) {
                document.getElementById('directoryBrowser').innerHTML = 
                    `<p style="color: red;">Error loading directories: ${error.message}</p>`;
            }
        }

        function selectDirectory(path) {
            if (currentBrowsingField) {
                document.getElementById(currentBrowsingField).value = path;
                updateSetting(currentBrowsingField.replace('-', '_'), path);
                closeDirectoryBrowser();
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('directoryModal');
            if (event.target == modal) {
                closeDirectoryBrowser();
            }
        }

        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            // Activate selected button
            event.target.classList.add('active');
            
            // Load logs when System tab is opened
            if (tabName === 'system') {
                loadLogs();
            }
        }

        async function loadLogs() {
            const logViewer = document.getElementById('log-viewer');
            const linesSelect = document.getElementById('log-lines');
            const lines = linesSelect ? parseInt(linesSelect.value) : 100;
            
            try {
                if (logViewer) {
                    logViewer.textContent = 'Loading logs...';
                    const response = await fetch(`/api/logs?lines=${lines}`);
                    const data = await response.json();
                    
                    if (data.status === 'ok' && data.lines) {
                        // Join log lines and display
                        logViewer.textContent = data.lines.join('\n');
                        // Auto-scroll to bottom
                        logViewer.scrollTop = logViewer.scrollHeight;
                    } else {
                        logViewer.textContent = 'No logs available';
                    }
                }
            } catch (error) {
                if (logViewer) {
                    logViewer.textContent = `Error loading logs: ${error.message}`;
                }
                console.error('Failed to load logs:', error);
            }
        }

        async function updateStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                document.getElementById('status-time').textContent = data.time || '--:--';
                document.getElementById('status-date').textContent = data.date || '---';
                document.getElementById('status-temp').textContent = data.temperature || '--¬∞C';
                document.getElementById('status-weather').textContent = data.weather || '---';
                document.getElementById('status-index').textContent = `${data.current_index} / ${data.total_images}`;
                document.getElementById('status-paused').textContent = data.paused ? 'Paused' : 'Playing';
                document.getElementById('current-image').textContent = data.current_image || 'No image loaded';
                
                // Update system stats if available
                if (data.system) {
                    const sys = data.system;
                    const memoryEl = document.getElementById('status-memory');
                    const cpuEl = document.getElementById('status-cpu');
                    const tempEl = document.getElementById('status-cpu-temp');
                    const diskFreeEl = document.getElementById('status-disk-free');
                    const diskUsedEl = document.getElementById('status-disk-used');
                    
                    if (memoryEl && sys.memory_free_mb !== undefined) {
                        memoryEl.textContent = `${sys.memory_free_mb} MB`;
                    }
                    if (cpuEl && sys.cpu_percent !== undefined) {
                        cpuEl.textContent = `${sys.cpu_percent}%`;
                    }
                    if (tempEl && sys.cpu_temp !== undefined) {
                        tempEl.textContent = `${sys.cpu_temp}¬∞C`;
                    }
                    if (diskFreeEl && sys.disk_free_gb !== undefined) {
                        diskFreeEl.textContent = `${sys.disk_free_gb} GB`;
                    }
                    if (diskUsedEl && sys.disk_used_percent !== undefined) {
                        diskUsedEl.textContent = `${sys.disk_used_percent}%`;
                    }
                }
                
                // Update image preview only when image changes
                const previewImg = document.getElementById('image-preview');
                if (data.current_image && data.current_image !== lastImageName) {
                    previewImg.src = `/api/image/preview?t=${Date.now()}`;
                    previewImg.style.display = 'block';
                    lastImageName = data.current_image;
                    // Load caption when image changes
                    loadCaption();
                } else if (!data.current_image) {
                    previewImg.style.display = 'none';
                    lastImageName = '';
                    // Clear caption when no image
                    document.getElementById('caption-text').value = '';
                    document.getElementById('caption-status').textContent = '';
                }
                
                isPaused = data.paused;
                document.getElementById('pauseBtn').textContent = isPaused ? '‚ñ∂Ô∏è Resume' : '‚è∏Ô∏è Pause';
            } catch (error) {
                console.error('Failed to update status:', error);
            }
        }

        async function loadSettings() {
            try {
                const response = await fetch('/api/settings');
                settings = await response.json();
                
                // Update toggle switches
                updateToggle('toggle-time', settings.show_time === 'true');
                updateToggle('toggle-date', settings.show_date === 'true');
                updateToggle('toggle-temp', settings.show_temperature === 'true');
                updateToggle('toggle-weather', settings.show_weather_code === 'true');
                updateToggle('toggle-filename', settings.show_filename === 'true');
                updateToggle('toggle-caption', settings.show_caption === 'true');

                // Update input fields
                if (document.getElementById('delay-seconds')) {
                    document.getElementById('delay-seconds').value = settings.delay_seconds || 30;
                }
                if (document.getElementById('display-on-time')) {
                    document.getElementById('display-on-time').value = settings.display_on_time || '05:00';
                }
                if (document.getElementById('display-off-time')) {
                    document.getElementById('display-off-time').value = settings.display_off_time || '23:00';
                }
                if (document.getElementById('location-city')) {
                    document.getElementById('location-city').value = settings.location_city_suburb || '';
                }
                if (document.getElementById('ui-text-alpha')) {
                    document.getElementById('ui-text-alpha').value = settings.ui_text_alpha || 192;
                }
                if (document.getElementById('aspect-landscape')) {
                    document.getElementById('aspect-landscape').value = settings.aspect_ratio_landscape || 1.5;
                }
                if (document.getElementById('aspect-portrait')) {
                    document.getElementById('aspect-portrait').value = settings.aspect_ratio_portrait || 0.667;
                }
                if (document.getElementById('weather-update')) {
                    document.getElementById('weather-update').value = settings.weather_update_seconds || 900;
                }
                if (document.getElementById('images-directory')) {
                    document.getElementById('images-directory').value = settings.images_directory || '';
                }
                if (document.getElementById('upload-directory')) {
                    document.getElementById('upload-directory').value = settings.upload_directory || '';
                }
            } catch (error) {
                console.error('Failed to load settings:', error);
            }
        }

        function updateSetting(key, value) {
            settings[key] = value;
            // Optionally auto-save, or wait for "Save Settings" button
        }

        function updateToggle(id, active) {
            const element = document.getElementById(id);
            if (active) {
                element.classList.add('active');
            } else {
                element.classList.remove('active');
            }
        }

        function toggleSetting(key, element) {
            element.classList.toggle('active');
            const isActive = element.classList.contains('active');
            settings[key] = isActive ? 'true' : 'false';
        }

        async function saveSettings() {
            try {
                // Collect all settings from form
                const allSettings = {
                    ...settings,
                    delay_seconds: parseInt(document.getElementById('delay-seconds')?.value || settings.delay_seconds),
                    display_on_time: document.getElementById('display-on-time')?.value || settings.display_on_time,
                    display_off_time: document.getElementById('display-off-time')?.value || settings.display_off_time,
                    location_city_suburb: document.getElementById('location-city')?.value || settings.location_city_suburb,
                    weather_update_seconds: parseInt(document.getElementById('weather-update')?.value || settings.weather_update_seconds),
                    ui_text_alpha: parseInt(document.getElementById('ui-text-alpha')?.value || settings.ui_text_alpha),
                    aspect_ratio_landscape: parseFloat(document.getElementById('aspect-landscape')?.value || settings.aspect_ratio_landscape),
                    aspect_ratio_portrait: parseFloat(document.getElementById('aspect-portrait')?.value || settings.aspect_ratio_portrait),
                    images_directory: document.getElementById('images-directory')?.value || settings.images_directory,
                    upload_directory: document.getElementById('upload-directory')?.value || settings.upload_directory,
                    save_to_config: true
                };
                
                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(allSettings)
                });
                
                if (response.ok) {
                    showAlert('Settings saved successfully!', 'success');
                } else {
                    showAlert('Failed to save settings', 'error');
                }
            } catch (error) {
                showAlert('Error saving settings: ' + error.message, 'error');
            }
        }

        async function nextImage() {
            try {
                const response = await fetch('/api/next', { method: 'POST' });
                if (response.ok) {
                    updateStatus();
                    showAlert('Moved to next image', 'success');
                }
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            }
        }

        async function previousImage() {
            try {
                const response = await fetch('/api/prev', { method: 'POST' });
                if (response.ok) {
                    updateStatus();
                    showAlert('Moved to previous image', 'success');
                }
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            }
        }

        async function loadCaption() {
            try {
                const response = await fetch('/api/image/caption');
                if (response.ok) {
                    const data = await response.json();
                    const captionText = document.getElementById('caption-text');
                    const statusEl = document.getElementById('caption-status');
                    
                    if (data.caption) {
                        captionText.value = data.caption;
                        statusEl.textContent = 'Caption loaded from image metadata';
                        statusEl.style.color = '#28a745';
                    } else {
                        captionText.value = '';
                        statusEl.textContent = 'No caption found in image metadata';
                        statusEl.style.color = '#666';
                    }
                } else {
                    const error = await response.json();
                    document.getElementById('caption-status').textContent = 'Error: ' + (error.error || 'Failed to load caption');
                    document.getElementById('caption-status').style.color = '#dc3545';
                }
            } catch (error) {
                document.getElementById('caption-status').textContent = 'Error: ' + error.message;
                document.getElementById('caption-status').style.color = '#dc3545';
            }
        }

        async function saveCaption() {
            try {
                const captionText = document.getElementById('caption-text');
                const statusEl = document.getElementById('caption-status');
                const saveBtn = document.getElementById('save-caption-btn');
                
                const caption = captionText.value.trim();
                
                // Disable button during save
                saveBtn.disabled = true;
                saveBtn.textContent = 'üíæ Saving...';
                statusEl.textContent = 'Saving caption...';
                statusEl.style.color = '#666';
                
                const response = await fetch('/api/image/caption', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ caption: caption })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    statusEl.textContent = data.message || 'Caption saved successfully!';
                    statusEl.style.color = '#28a745';
                    showAlert('Caption saved to image metadata', 'success');
                } else {
                    const error = await response.json();
                    statusEl.textContent = 'Error: ' + (error.error || 'Failed to save caption');
                    statusEl.style.color = '#dc3545';
                    showAlert('Failed to save caption: ' + (error.error || 'Unknown error'), 'error');
                }
                
                // Re-enable button
                saveBtn.disabled = false;
                saveBtn.textContent = 'üíæ Save Caption';
            } catch (error) {
                document.getElementById('caption-status').textContent = 'Error: ' + error.message;
                document.getElementById('caption-status').style.color = '#dc3545';
                document.getElementById('save-caption-btn').disabled = false;
                document.getElementById('save-caption-btn').textContent = 'üíæ Save Caption';
                showAlert('Error saving caption: ' + error.message, 'error');
            }
        }

        async function togglePause() {
            try {
                const response = await fetch('/api/pause', { method: 'POST' });
                if (response.ok) {
                    updateStatus();
                    const data = await response.json();
                    showAlert(data.paused ? 'Slideshow paused' : 'Slideshow resumed', 'success');
                }
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            }
        }

        async function setDisplay(action) {
            try {
                const response = await fetch('/api/display', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action })
                });
                
                if (response.ok) {
                    const messages = {
                        'on': 'Display turned on',
                        'off': 'Display turned off',
                        'auto': 'Display set to auto mode'
                    };
                    showAlert(messages[action], 'success');
                    updateStatus();
                }
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            }
        }

        // Store selected files for preview
        let selectedFiles = [];

        function handleFileSelect(files) {
            // Add new files to the selection
            for (let file of files) {
                // Check if file is already in the list
                if (!selectedFiles.find(f => f.name === file.name && f.size === file.size && f.lastModified === file.lastModified)) {
                    selectedFiles.push(file);
                }
            }
            updateFilePreview();
        }

        function updateFilePreview() {
            const previewDiv = document.getElementById('uploadPreview');
            const fileListDiv = document.getElementById('fileList');
            
            if (selectedFiles.length === 0) {
                previewDiv.style.display = 'none';
                return;
            }
            
            previewDiv.style.display = 'block';
            fileListDiv.innerHTML = '';
            
            selectedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.style.cssText = 'display: flex; align-items: center; gap: 6px; padding: 6px 8px; margin-bottom: 4px; background: white; border-radius: 5px; border: 1px solid #e0e0e0; min-width: 0; width: 100%; box-sizing: border-box;';
                
                // Store original filename and extension
                const originalName = file.name;
                const lastDot = originalName.lastIndexOf('.');
                const baseName = lastDot > 0 ? originalName.substring(0, lastDot) : originalName;
                const extension = lastDot > 0 ? originalName.substring(lastDot) : '';
                const displayName = file.customName || originalName;
                
                const fileInfoContainer = document.createElement('div');
                fileInfoContainer.style.cssText = 'flex: 1; min-width: 0; display: flex; align-items: center; gap: 6px;';
                
                const fileInfo = document.createElement('span');
                fileInfo.style.cssText = 'flex: 1; color: #333; font-size: 0.9em; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; min-width: 0; cursor: pointer;';
                const fileSize = (file.size / 1024 / 1024).toFixed(2);
                fileInfo.textContent = `${displayName} (${fileSize} MB)`;
                fileInfo.title = `Click to rename: ${displayName} (${fileSize} MB)`;
                
                // Make filename editable on click
                const startEdit = () => {
                    const input = document.createElement('input');
                    input.type = 'text';
                    // Use current custom name or original base name
                    const currentBaseName = file.customName ? file.customName.substring(0, file.customName.lastIndexOf('.')) : baseName;
                    input.value = currentBaseName;
                    input.style.cssText = 'flex: 1; padding: 2px 4px; border: 1px solid #667eea; border-radius: 3px; font-size: 0.9em; min-width: 0;';
                    input.style.width = '100%';
                    
                    const saveRename = () => {
                        const newName = input.value.trim();
                        if (newName && newName.length > 0) {
                            // Only update if name actually changed
                            const newFullName = newName + extension;
                            if (newFullName !== originalName) {
                                file.customName = newFullName;
                                fileInfo.textContent = `${file.customName} (${fileSize} MB)`;
                                fileInfo.title = `Click to rename: ${file.customName} (${fileSize} MB)`;
                            } else {
                                // Reverted to original, clear custom name
                                file.customName = null;
                                fileInfo.textContent = `${originalName} (${fileSize} MB)`;
                                fileInfo.title = `Click to rename: ${originalName} (${fileSize} MB)`;
                            }
                        } else {
                            // Empty name, revert to original
                            file.customName = null;
                            fileInfo.textContent = `${originalName} (${fileSize} MB)`;
                            fileInfo.title = `Click to rename: ${originalName} (${fileSize} MB)`;
                        }
                        fileInfoContainer.replaceChild(fileInfo, input);
                        // Re-attach click handler
                        fileInfo.onclick = startEdit;
                    };
                    
                    const cancelRename = () => {
                        fileInfoContainer.replaceChild(fileInfo, input);
                        // Re-attach click handler
                        fileInfo.onclick = startEdit;
                    };
                    
                    input.onblur = saveRename;
                    input.onkeydown = (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            saveRename();
                        } else if (e.key === 'Escape') {
                            e.preventDefault();
                            cancelRename();
                        }
                    };
                    
                    fileInfoContainer.replaceChild(input, fileInfo);
                    input.focus();
                    input.select();
                };
                
                fileInfo.onclick = startEdit;
                
                const removeBtn = document.createElement('button');
                removeBtn.textContent = '√ó';
                removeBtn.style.cssText = 'background: #dc3545; color: white; border: none; border-radius: 2px; padding: 0; margin: 0; cursor: pointer; font-size: 12px; font-weight: bold; flex-shrink: 0; width: 16px !important; height: 16px !important; min-width: 16px !important; max-width: 16px !important; line-height: 1; display: inline-flex; align-items: center; justify-content: center; box-sizing: border-box;';
                removeBtn.title = 'Remove file';
                removeBtn.onclick = () => {
                    selectedFiles.splice(index, 1);
                    updateFilePreview();
                };
                
                fileInfoContainer.appendChild(fileInfo);
                fileItem.appendChild(fileInfoContainer);
                fileItem.appendChild(removeBtn);
                fileListDiv.appendChild(fileItem);
            });
        }

        function clearFileSelection() {
            selectedFiles = [];
            document.getElementById('fileInput').value = '';
            const captionInput = document.getElementById('upload-caption');
            if (captionInput) {
                captionInput.value = '';
            }
            updateFilePreview();
            document.getElementById('uploadStatus').innerHTML = '';
        }

        async function uploadSelectedFiles() {
            if (selectedFiles.length === 0) {
                showAlert('No files selected', 'error');
                return;
            }

            const uploadStatus = document.getElementById('uploadStatus');
            const uploadBtn = document.getElementById('uploadBtn');
            uploadStatus.innerHTML = '';
            
            // Disable upload button during upload
            uploadBtn.disabled = true;
            uploadBtn.textContent = '‚è≥ Uploading...';

            // Get caption from input field (applies to all files)
            const captionInput = document.getElementById('upload-caption');
            const caption = captionInput ? captionInput.value.trim() : '';

            let successCount = 0;
            let failCount = 0;

            for (let file of selectedFiles) {
                const formData = new FormData();
                // Use custom name if set, otherwise use original filename
                const fileName = file.customName || file.name;
                // Create a new File object with the custom name if renamed
                const fileToUpload = file.customName ? new File([file], fileName, { type: file.type, lastModified: file.lastModified }) : file;
                formData.append('file', fileToUpload);
                if (caption) {
                    formData.append('caption', caption);
                }

                try {
                    uploadStatus.innerHTML += `<p>Uploading ${file.name}...</p>`;
                    const response = await fetch('/api/upload', {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const captionMsg = caption ? ' with caption' : '';
                        uploadStatus.innerHTML += `<p style="color: green;">‚úÖ ${file.name} uploaded successfully${captionMsg}!</p>`;
                        successCount++;
                    } else {
                        const data = await response.json();
                        uploadStatus.innerHTML += `<p style="color: red;">‚ùå ${file.name}: ${data.error}</p>`;
                        failCount++;
                    }
                } catch (error) {
                    uploadStatus.innerHTML += `<p style="color: red;">‚ùå ${file.name}: ${error.message}</p>`;
                    failCount++;
                }
            }

            // Re-enable upload button
            uploadBtn.disabled = false;
            uploadBtn.textContent = 'üì§ Upload All';

            // Show summary
            if (successCount > 0) {
                showAlert(`Successfully uploaded ${successCount} file(s)${failCount > 0 ? `, ${failCount} failed` : ''}`, failCount > 0 ? 'error' : 'success');
            } else {
                showAlert('Upload failed for all files', 'error');
            }

            // Clear selection after successful upload
            if (failCount === 0) {
                clearFileSelection();
            }
            
            // Refresh status after upload
            setTimeout(updateStatus, 1000);
        }

        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = `alert ${type}`;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 3000);
        }

        function showFullImage() {
            const modal = document.getElementById('imageModal');
            const fullImg = document.getElementById('full-image');
            const previewImg = document.getElementById('image-preview');
            
            if (previewImg.src) {
                // Use the full image endpoint
                fullImg.src = `/api/image/full?t=${Date.now()}`;
                modal.style.display = 'block';
            }
        }

        function closeFullImage(event) {
            const modal = document.getElementById('imageModal');
            // Close if clicking on the background or the close button
            if (event.target === modal || event.target.classList.contains('image-modal-close')) {
                modal.style.display = 'none';
            }
        }

        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('imageModal');
                if (modal.style.display === 'block') {
                    modal.style.display = 'none';
                }
            }
        });
    </script>
</body>
</html>

